name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    runs-on: plasma
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t oli-torus:${{ github.sha }} .

      - name: Deploy PR stack
        run: |
          PROJECT=pr${{ github.event.number }}
          APP_IMAGE_TAG=${{ github.sha }}
          HOST=pr${{ github.event.number }}.plasma.oli.cmu.edu

          docker-compose -p $PROJECT \
            -f devops/docker-compose.yml \
            -f devops/docker-compose.override.yml \
            up -d --build
