name: Preview Cleanup

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: plasma
    steps:
      - name: ðŸ§¹ Cleanup Preview Deployment
        run: |
          export DEPLOYMENT=$(echo ${{ github.event_name == 'workflow_dispatch' && format('{0}', github.ref_name) || format('pr-{0}', github.event.number) }} | tr '/#?' '-' | cut -c1-32)

          echo "Cleaning up preview deployment: $DEPLOYMENT"

          # Primary cleanup - this should handle most cases
          if docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml down -v; then
            echo "Docker compose cleanup successful"
          else
            echo "Docker compose cleanup failed, performing manual cleanup..."

            # Fallback cleanup for edge cases
            docker ps -a --filter "name=$DEPLOYMENT" -q | xargs -r docker rm -f || true
            docker network ls --filter "name=$DEPLOYMENT" -q | xargs -r docker network rm || true
            docker volume ls --filter "name=$DEPLOYMENT" -q | xargs -r docker volume rm || true
          fi

          echo "Cleanup completed for $DEPLOYMENT"

      - name: ðŸ’¬ Post cleanup notification
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}
          issue-number: ${{ github.event.number }}
          body: "ðŸ§¹ Preview deployment has been cleaned up."
