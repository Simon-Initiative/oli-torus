name: Build & Test CI

on:
  pull_request:
    branches:
      - master
      - test
      - production
  push:
    branches:
      - master
      - test
      - production
      - test-deploy   # TODO: REMOVE

jobs:
  elixir-build-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v2

      - name: ğŸ”§ Configure
        run: cp oli.example.env oli.env && cp postgres.example.env postgres.env

      - name: ğŸ—„ Start test database
        run: docker-compose up -d postgres

      - name: ğŸ§ª Setup elixir
        uses: actions/setup-elixir@v1
        with:
          elixir-version: 1.10.2 # Define the elixir version [required]
          otp-version: 22.2 # Define the OTP version [required]

      - name: â¬‡ï¸ Install elixir dependencies
        run: mix deps.get

      - name: ğŸ”¨ Build dependencies
        run: mix deps.compile

      - name: ğŸ”¨ Build project
        run: set -a;source oli.env && mix clean && mix compile --warnings-as-errors

      - name: âš™ï¸ Run tests
        run: set -a;source oli.env && mix test.coverage

  ts-build-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v2

      - name: ğŸ”§ Configure
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'

      - name: ğŸ§ª Setup elixir
        uses: actions/setup-elixir@v1
        with:
          elixir-version: 1.10.2 # Define the elixir version [required]
          otp-version: 22.2 # Define the OTP version [required]

      - name: â¬‡ï¸ Install elixir dependencies
        run: mix deps.get

      - name: Install node_module dependencies ğŸ“¦
        run: cd assets && npm install

      - name: ğŸ§¹ Lint
        run: cd assets && npm run lint

      - name: ğŸ”¨ Build
        run: cd assets && npm run deploy

      - name: âš™ï¸ Test
        run: cd assets && npm run test

  build-release:
    runs-on: ubuntu-latest
    needs: [elixir-build-test, ts-build-test]

    # only run this job if the workflow is running on the master branch
    # if: github.ref == 'refs/heads/master'
    if: github.ref == 'refs/heads/test-deploy'   # TODO: REPLACE WITH MASTER

    container:
      image: amazonlinux:2
      env:
        MIX_ENV: prod

    steps:
      - name: ğŸ”§ Setup container
        run: |
          yum update -y
          yum install -y tar

      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v2

      - name: ğŸ§ª Setup elixir
        uses: actions/setup-elixir@v1
        with:
          elixir-version: 1.10.2 # Define the elixir version [required]
          otp-version: 22.2 # Define the OTP version [required]

      - name: ğŸ”§ Setup node
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'

      - name: â¬‡ï¸ Install elixir dependencies
        run: mix deps.get --only prod

      - name: ğŸ”¨ Compile elixir
        run: mix compile

      - name: â¬‡ï¸ Install / update  JavaScript dependencies
        run: npm install --prefix ./assets

      - name: ğŸ”¨ Compile JavaScript assets
        run: |
          npm run deploy --prefix ./assets
          mix phx.digest

      - name: ğŸ“¦ Package release
        run: mix release

      - name: ğŸ“¦â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: oli-release-$GITHUB_SHA
          path: _build/prod/rel/oli

      # - name: ğŸ“¦â¬†ï¸ Upload release to S3
      # - uses: jakejarvis/s3-sync-action@master
      #   # with:
      #   #   args: --acl public-read --follow-symlinks --delete
      #   env:
      #     AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: 'us-east-2'
      #     SOURCE_DIR: '_build/prod/rel/oli'
      #     DEST_DIR: ${{ GITHUB_SHA }}
