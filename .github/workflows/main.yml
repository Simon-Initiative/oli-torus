name: Build & Test CI

on:
  pull_request:
    branches:
      - master
      - test
      - production
  push:
    branches:
      - master
      - test
      - production
      - test-deploy  # TODO: REMOVE

jobs:
  # elixir-build-test:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: ðŸ›Žï¸ Checkout
  #       uses: actions/checkout@v2

  #     - name: ðŸ”§ Configure
  #       run: cp oli.example.env oli.env && cp postgres.example.env postgres.env

  #     - name: ðŸ—„ Start test database
  #       run: docker-compose up -d postgres

  #     - name: ðŸ§ª Setup elixir
  #       uses: actions/setup-elixir@v1
  #       with:
  #         elixir-version: 1.10.2 # Define the elixir version [required]
  #         otp-version: 22.2 # Define the OTP version [required]

  #     - name: â¬‡ï¸ Install elixir dependencies
  #       run: mix deps.get

  #     - name: ðŸ”¨ Build dependencies
  #       run: mix deps.compile

  #     - name: ðŸ”¨ Build project
  #       run: set -a;source oli.env && mix clean && mix compile --warnings-as-errors

  #     - name: âš™ï¸ Run tests
  #       run: set -a;source oli.env && mix test.coverage

  # ts-build-test:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: ðŸ›Žï¸ Checkout
  #       uses: actions/checkout@v2

  #     - name: ðŸ”§ Configure
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: '12.x'

  #     - name: ðŸ§ª Setup elixir
  #       uses: actions/setup-elixir@v1
  #       with:
  #         elixir-version: 1.10.2 # Define the elixir version [required]
  #         otp-version: 22.2 # Define the OTP version [required]

  #     - name: â¬‡ï¸ Install elixir dependencies
  #       run: mix deps.get

  #     - name: Install node_module dependencies ðŸ“¦
  #       run: cd assets && npm install

  #     - name: ðŸ§¹ Lint
  #       run: cd assets && npm run lint

  #     - name: ðŸ”¨ Build
  #       run: cd assets && npm run deploy

  #     - name: âš™ï¸ Test
  #       run: cd assets && npm run test

  release-and-deploy:
    runs-on: ubuntu-latest
    # needs: [elixir-build-test, ts-build-test]

    # only release and deploy if the workflow is running on the test branch
    # TODO: add support for production deployments
    # if: github.ref == 'refs/heads/test'
    if: github.ref == 'refs/heads/test-deploy'

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v2

      - name: ðŸ§¾ Build info
        id: info
        run: |
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
          echo "::set-output name=app_version::$(cat mix.exs | grep version | sed -e 's/.*version: "\(.*\)",/\1/')"

      - name: ðŸ“¦ðŸ’½ Package release
        uses: ./.github/actions/phoenix-builder
        with:
          build-sha: ${{ steps.info.outputs.sha_short }}

      - name: ðŸ’½â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: oli-${{ steps.info.outputs.app_version }}-${{ steps.info.outputs.sha_short }}
          path: _build/prod/rel/oli

      # TODO: add S3 archive support
      # - name: ðŸ’½â¬†ï¸ Upload release to S3 archive
      #   uses: jakejarvis/s3-sync-action@master
      #   with:
      #     args: --acl public-read --follow-symlinks --delete
      #   env:
      #     AWS_S3_BUCKET: 'oli-torus-releases'
      #     AWS_ACCESS_KEY_ID: ${{ secrets.SIMON_BOT_AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.SIMON_BOT_AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: 'us-east-2'
      #     SOURCE_DIR: 'oli-${{ steps.info.outputs.app_version }}-${{ steps.info.outputs.sha_short }}'

      - name: ðŸ—œï¸ðŸš¢ Zip it & ship it
        run: |
          zip -r oli-${{ steps.info.outputs.app_version }}-${{ steps.info.outputs.sha_short }}.zip _build/prod/rel/oli
          mkdir ~/.ssh
          echo "${{ secrets.SIMON_BOT_PRIVATE_KEY}}" > ~/.ssh/simon-bot
          chmod 600 ~/.ssh/simon-bot
          sftp -i ~/.ssh/simon-bot -o StrictHostKeyChecking=no simon-bot@tokamak.oli.cmu.edu  <<< $'cd /torus\n put oli-${{ steps.info.outputs.app_version }}-${{ steps.info.outputs.sha_short }}.zip'

      - name: ðŸ’° Deploy using SSH
        uses: fifsky/ssh-action@master
        with:
          command: |
            cd /torus
            sh deploy.sh ${{ steps.info.outputs.app_version }} ${{ steps.info.outputs.sha_short }}
          host: tokamak.oli.cmu.edu
          user: simon-bot
          key: ${{ secrets.SIMON_BOT_PRIVATE_KEY}}
