name: Build & Test PR

on:
  pull_request:
    branches:
      - master
      - hotfix-*
      - prerelease-*

jobs:
  elixir-build-test:
    name: Elixir build and test
    runs-on: ubuntu-latest

    env:
      MIX_ENV: test
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üîß Configure
        run: |
          cp postgres.example.env postgres.env
          cat > oli.env <<EOL
          ${{ secrets.CI_OLI_ENV }}
          EOL

      - name: üóÑ Start test database
        run: docker-compose up -d postgres

      - name: üíæ Restore the deps cache
        id: mix-deps-cache
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: üíæ Restore the Node.js cache
        id: yarn-cache
        uses: actions/cache@v3
        with:
          path: assets/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('assets/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: üß™ Setup elixir
        uses: erlef/setup-elixir@v1
        with:
          elixir-version: 1.15.5 # Define the elixir version [required]
          otp-version: 26.1 # Define the OTP version [required]

      - name: ‚¨áÔ∏è Install elixir dependencies
        run: mix deps.get

      - name: üî® Build dependencies
        run: mix deps.compile

      - name: üßπ Clean on master
        if: github.ref == 'refs/heads/master'
        run: set -a;source oli.env && mix clean

      - name: üî® Build project
        run: set -a; source oli.env && mix compile --warnings-as-errors

      - name: ‚ñ∂Ô∏è Run unit tests
        run: set -a;source oli.env && MIX_ENV=test mix ecto.reset && mix test

      - name: üì¶ Install node_module dependencies
        run: yarn --cwd assets --frozen-lockfile

      # - name: ‚ñ∂Ô∏è Run integration tests
      #   run: |
      #     /usr/local/share/chrome_driver/chromedriver &
      #     timeout 90 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' localhost:9515)" != "404" ]]; do sleep 1; done' || false
      #     set -a;source oli.env && MIX_ENV=hound mix test.hound

      # - name: üìà Save test results
      #   uses: actions/upload-artifact@v3
      #   if: failure()
      #   with:
      #     name: integration-test-results
      #     path: test-results
      #     if-no-files-found: ignore

  check-simon-token:
    name: Check simon-bot access token
    runs-on: ubuntu-latest
    outputs:
      available: ${{ steps.check_token.outputs.available }}
    steps:
      - name: Check whether SIMON_BOT_PERSONAL_ACCESS_TOKEN is set
        id: check_token
        run: echo "available=$(if [ "${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}" != "" ] ; then echo true ; else echo false ; fi)" >> $GITHUB_OUTPUT

  auto-format:
    name: Auto format and lint
    runs-on: ubuntu-latest
    needs: check-simon-token
    if: needs.check-simon-token.outputs.available == 'true'

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}

      - name: üîß Configure
        uses: actions/setup-node@v1
        with:
          node-version: "16.14.2"

      - name: üß™ Setup elixir
        uses: erlef/setup-elixir@v1
        with:
          elixir-version: 1.15.5 # Define the elixir version [required]
          otp-version: 26.1 # Define the OTP version [required]

      - name: ‚¨áÔ∏è Install elixir dependencies
        run: mix deps.get

      - name: üì¶ Install node_module dependencies
        run: yarn --cwd assets --frozen-lockfile

      - name: ü§ñ Auto format
        run: yarn --cwd assets run format

      - name: ‚úÖ Commit
        uses: EndBug/add-and-commit@v9
        with:
          message: Auto format
          committer_name: Simon Bot (GitHub Actions)
          committer_email: simondevbot@gmail.com

  ts-build-test:
    name: TypeScript build and test
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: üîß Configure
        uses: actions/setup-node@v1
        with:
          node-version: "16.14.2"

      - name: üß™ Setup elixir
        uses: erlef/setup-elixir@v1
        with:
          elixir-version: 1.15.5 # Define the elixir version [required]
          otp-version: 26.1 # Define the OTP version [required]

      - name: ‚¨áÔ∏è Install elixir dependencies
        run: mix deps.get

      - name: üì¶ Install node_module dependencies
        run: yarn --cwd assets --frozen-lockfile

      - name: üßπ Lint
        run: yarn --cwd assets run prettier && yarn --cwd assets run lint

      - name: üëÅÔ∏è Typecheck
        run: yarn --cwd assets run check-types

      - name: üî® Build
        run: yarn --cwd assets run deploy

      - name: ‚öôÔ∏è Test
        run: yarn --cwd assets run test

  container:
    name: Container build and push
    runs-on: ubuntu-latest

    outputs:
      app_version: ${{ steps.info.outputs.app_version }}
      sha_short: ${{ steps.info.outputs.sha_short }}
      deploy_host: ${{ steps.info.outputs.deploy_host }}

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üßæ Build info
        id: info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "app_version=$(cat mix.exs | grep version | sed -e 's/.*version: "\(.*\)",/\1/')" >> $GITHUB_OUTPUT

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          # list of Docker images to use as base name for tags
          images: |
            olisimon/oli-torus
            ghcr.io/SimonInitiative/oli-torus
          # generate Docker tags based on the following events/attributes
          tags: |
            type=ref,event=pr
            type=sha

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.SIMON_DOCKERHUB_USERNAME }}
          password: ${{ secrets.SIMON_DOCKERHUB_TOKEN }}

      - name: üê≥ Docker Build and Push
        uses: docker/build-push-action@v2
        with:
          context: .
          build-args: APP_VERSION=${{ steps.info.outputs.app_version }}
            SHA_SHORT=${{ steps.info.outputs.sha_short }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
