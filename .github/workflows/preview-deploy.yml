name: Preview Deploy

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      preview_id:
        description: "Preview identifier (namespace/hostname prefix)"
        required: true
      preview_domain:
        description: "Override preview domain"
        required: false

jobs:
  simon-token-available:
    name: Check simon-bot Access Token
    runs-on: ubuntu-latest
    outputs:
      available: ${{ steps.check_token.outputs.available }}
    steps:
      - name: Check whether SIMON_BOT_PERSONAL_ACCESS_TOKEN is set
        id: check_token
        run: echo "available=$(if [ "${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}" != "" ] ; then echo true ; else echo false ; fi)" >> $GITHUB_OUTPUT

  preview-context:
    name: Determine Preview Context
    runs-on: ubuntu-latest
    needs: simon-token-available
    if: needs.simon-token-available.outputs.available == 'true'
    outputs:
      preview_slug: ${{ steps.compute.outputs.preview_slug }}
      target_ref: ${{ steps.compute.outputs.target_ref }}
      preview_domain: ${{ steps.compute.outputs.preview_domain }}
      is_pr: ${{ steps.compute.outputs.is_pr }}
    steps:
      - id: compute
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "preview_slug=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "target_ref=${{ github.head_ref || github.ref_name }}" >> $GITHUB_OUTPUT
            echo "preview_domain=${{ vars.PREVIEW_DOMAIN || 'plasma.oli.cmu.edu' }}" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "preview_slug=${{ inputs.preview_id }}" >> $GITHUB_OUTPUT
            echo "target_ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            domain="${{ inputs.preview_domain }}"
            if [ -z "$domain" ]; then
              domain="${{ vars.PREVIEW_DOMAIN || 'plasma.oli.cmu.edu' }}"
            fi
            echo "preview_domain=$domain" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

  build-container:
    name: Build Container
    runs-on: ubuntu-latest
    needs: [simon-token-available, preview-context]
    if: needs.simon-token-available.outputs.available == 'true'
    env:
      TARGET_REF: ${{ needs.preview-context.outputs.target_ref }}
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.TARGET_REF }}

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: üßæ Build info
        run: |
          echo "SHA_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "APP_VERSION=$(cat mix.exs | grep version | sed -e 's/.*version: \"\(.*\)\",/\1/')" >> $GITHUB_ENV

      - name: üßæ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # list of Docker images to use as base name for tags
          images: |
            ghcr.io/simon-initiative/oli-torus
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=${{ env.SHA_SHORT }},prefix=sha-

      - name: üîë Log in to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # builds the official oli-torus app image
      - name: üê≥ Docker Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            APP_VERSION=${{ env.APP_VERSION }}
            SHA=${{ env.SHA_SHORT }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    name: Preview Deploy
    runs-on: plasma
    needs: [build-container, preview-context]
    env:
      PREVIEW_SLUG: ${{ needs.preview-context.outputs.preview_slug }}
      PREVIEW_DOMAIN: ${{ needs.preview-context.outputs.preview_domain }}
      IS_PR: ${{ needs.preview-context.outputs.is_pr }}
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      IMAGE_REPO: ghcr.io/simon-initiative/oli-torus
      IMAGE_TAG: ${{ needs.build-container.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Apply cluster RBAC baseline
        run: kubectl apply -f devops/k8s/rbac/pr-admin.yaml

      - name: Prepare namespace and policies
        run: devops/scripts/apply-preview-policies.sh "${PREVIEW_SLUG}"

      - name: Ensure image pull secret
        env:
          CR_PAT: ${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}
          REGISTRY_USER: simon-bot
        run: |
          kubectl -n "${PREVIEW_SLUG}" delete secret ghcr-creds --ignore-not-found
          kubectl -n "${PREVIEW_SLUG}" create secret docker-registry ghcr-creds \
            --docker-server=ghcr.io \
            --docker-username="${REGISTRY_USER}" \
            --docker-password="${CR_PAT}" \
            --docker-email="${REGISTRY_USER}@users.noreply.github.com"

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v1
        with:
          kustomize-version: "5.4.1"

      - name: Render and apply Kustomize overlay
        env:
          PLASMA_CORE_SERVICE_TOKEN: ${{ secrets.PLASMA_CORE_SERVICE_TOKEN }}
        run: |
          set -euo pipefail

          REPO_ROOT=$(pwd)
          PREVIEW_HOST="${PREVIEW_SLUG}.${PREVIEW_DOMAIN}"

          cat <<EOF > "${REPO_ROOT}/devops/kustomize/overlays/preview/params.env"

          PREVIEW_SLUG=${PREVIEW_SLUG}
          PREVIEW_DOMAIN=${PREVIEW_DOMAIN}
          PREVIEW_HOST=${PREVIEW_HOST}
          MINIO_API_MIDDLEWARE=${PREVIEW_SLUG}-minio-api-strip@kubernetescrd
          MINIO_CONSOLE_MIDDLEWARE=${PREVIEW_SLUG}-minio-console-strip@kubernetescrd
          MINIO_SERVER_URL=https://${PREVIEW_HOST}/buckets
          MINIO_BROWSER_REDIRECT_URL=https://${PREVIEW_HOST}/minio
          EOF

          printf 'HOST=%s\nMEDIA_URL=https://%s/buckets/torus-media\n' "${PREVIEW_HOST}" "${PREVIEW_HOST}" > "${REPO_ROOT}/devops/kustomize/overlays/preview/app-overrides.env"

          ENVIRONMENT="oli-torus"
          DEPLOYMENT="${PREVIEW_SLUG}"
          CONFIG_URL="https://plasma.oli.cmu.edu/api/environments/${ENVIRONMENT}/deployments/${DEPLOYMENT}/env"
          DEFAULT_ENV_PATH="${REPO_ROOT}/devops/default.env"
          APP_ENV_PATH="${REPO_ROOT}/devops/kustomize/base/app.env"

          if curl -fsSL --max-time 10 -H "Authorization: Bearer ${PLASMA_CORE_SERVICE_TOKEN:-}" "${CONFIG_URL}" -o "${APP_ENV_PATH}"; then
            echo "Downloaded environment config from ${CONFIG_URL}"
          else
            echo "Failed to download environment config; building fallback from devops/default.env"
            if ! command -v envsubst >/dev/null 2>&1; then
              echo "envsubst is required to render devops/kustomize/base/app.env" >&2
              exit 1
            fi
            HOST="${PREVIEW_HOST}" envsubst < "${DEFAULT_ENV_PATH}" > "${APP_ENV_PATH}"
            echo "Generated fallback env file from devops/default.env"
          fi

          cd devops/kustomize/overlays/preview
          kustomize edit set namespace "${PREVIEW_SLUG}"
          kustomize edit set image ${IMAGE_REPO}=${IMAGE_REPO}:${IMAGE_TAG}

          kustomize build --load-restrictor LoadRestrictionsNone . | kubectl apply -f -

      - name: Restart app deployment
        run: kubectl -n "${PREVIEW_SLUG}" rollout restart deployment/app

      - name: Wait for application rollout
        run: kubectl -n "${PREVIEW_SLUG}" rollout status deployment/app --timeout=5m

      - name: Post preview URL
        if: env.IS_PR == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            Preview deployed to: https://${{ env.PREVIEW_SLUG }}.${{ env.PREVIEW_DOMAIN }}

      - name: Cleanup workspace
        if: always()
        run: |
          git reset --hard HEAD
          git clean -fdx
