name: Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Limit concurrent deployments to prevent resource exhaustion
concurrency:
  group: preview-deployment-${{ github.repository }}
  cancel-in-progress: false # Don't cancel running deployments

jobs:
  simon-token-available:
    name: Check if simon-bot access token is available
    runs-on: ubuntu-latest
    outputs:
      available: ${{ steps.check_token.outputs.available }}
    steps:
      - name: Check whether SIMON_BOT_PERSONAL_ACCESS_TOKEN is set
        id: check_token
        run: echo "available=$(if [ "${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}" != "" ] ; then echo true ; else echo false ; fi)" >> $GITHUB_OUTPUT

  build-container:
    runs-on: ubuntu-latest
    needs: simon-token-available
    if: needs.simon-token-available.outputs.available == 'true'
    permissions:
      contents: read
      packages: write

    outputs:
      app_version: ${{ steps.info.outputs.app_version }}
      sha_short: ${{ steps.info.outputs.sha_short }}

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: üßæ Build info
        id: info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "app_version=$(cat mix.exs | grep version | sed -e 's/.*version: "\(.*\)",/\1/')" >> $GITHUB_OUTPUT

      - name: üßæ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # list of Docker images to use as base name for tags
          images: |
            ghcr.io/simon-initiative/oli-torus
          # generate Docker tags based on the following events/attributes
          tags: |
            type=sha,prefix=sha-,format=long

      - name: üîë Log in to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # builds the official oli-torus app image
      - name: üê≥ Docker Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: APP_VERSION=${{ steps.info.outputs.app_version }}
            SHA_SHORT=${{ steps.info.outputs.sha_short }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    name: Preview Deploy
    runs-on: plasma
    needs: build-container
    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: üßæ Build info
        id: info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: üìë Preflight check
        id: preflight
        run: |
          # Get available memory in MB
          AVAILABLE_MEMORY=$(free -m | awk 'NR==2{printf "%.0f", $7}')
          REQUIRED_MEMORY=1024  # Require at least 1GB available

          echo "üìä Current system status:"
          echo "  Available memory: ${AVAILABLE_MEMORY}MB"
          echo "  Required memory: ${REQUIRED_MEMORY}MB"

          if [ $AVAILABLE_MEMORY -lt $REQUIRED_MEMORY ]; then
            echo "‚ùå Insufficient memory available. Need at least ${REQUIRED_MEMORY}MB, but only ${AVAILABLE_MEMORY}MB available."
            echo "memory_insufficient=true" >> $GITHUB_OUTPUT
            echo "available_memory=${AVAILABLE_MEMORY}" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Sufficient memory available for deployment"
            echo "memory_insufficient=false" >> $GITHUB_OUTPUT
          fi

      - name: üí¨ Post memory error comment
        if: steps.preflight.outputs.memory_insufficient == 'true' && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}
          issue-number: ${{ github.event.number }}
          body: |
            ‚ö†Ô∏è **Deployment skipped due to insufficient memory**

            **Current system status:**
            - Available memory: ${{ steps.preflight.outputs.available_memory }}MB
            - Required memory: 1024MB

            **What you can do:**
            - Wait for other deployments to be cleaned up automatically
            - Ask maintainers to manually clean up old deployments
            - Try again later when system resources are available

            The deployment will automatically retry when you push new commits to this PR.

            *Last checked: ${{ github.event.pull_request.updated_at }}*

      - name: üîë Log in to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Pull Docker image
        run: |
          docker pull ghcr.io/simon-initiative/oli-torus:sha-${{ github.sha }}

      - name: üöÄ Deploy
        if: steps.preflight.outputs.memory_insufficient != 'true'
        run: |
          export DEPLOYMENT=$(echo ${{ github.event_name == 'workflow_dispatch' && format('{0}', github.ref_name) || format('pr{0}', github.event.number) }} | tr '/#?' '-' | cut -c1-32)
          export APP_IMAGE_TAG=sha-${{ github.sha }}
          export HOST=$DEPLOYMENT.plasma.oli.cmu.edu

          ENVIRONMENT=oli-torus
          CONFIG_URL="https://plasma.oli.cmu.edu/api/environments/$ENVIRONMENT/deployments/$DEPLOYMENT/env"
          ENV_FILE="devops/.env"

          # Always clean up the generated env file at exit
          trap 'rm -f "$ENV_FILE" && touch .env' EXIT

          # Fetch environment config or render fallback from devops/default.env
          if curl -fsSL --max-time 10 -H "Authorization: Bearer ${{ secrets.PLASMA_CORE_SERVICE_TOKEN }}" "$CONFIG_URL" -o "$ENV_FILE"; then
            echo "Downloaded environment config from $CONFIG_URL"
          else
            echo "Failed to download environment config; building fallback from devops/default.env"
            if [ -f devops/default.env ]; then
              envsubst < devops/default.env > "$ENV_FILE"
              echo "Generated fallback env file from devops/default.env"
            else
              echo "devops/default.env not found; using empty file"
              : > "$ENV_FILE"
            fi
          fi

          # Setup database
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml run --rm app /app/bin/oli eval "Oli.Release.setup"

          # Run minio first and wait for it to be ready
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml up -d minio && sleep 5

          # Create minio buckets and set policies
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml exec minio /bin/sh -c "mc alias set localminio http://localhost:9000 minio-user minio-password && mc mb --ignore-existing localminio/torus-media"
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml exec minio /bin/sh -c "mc alias set localminio http://localhost:9000 minio-user minio-password && mc mb --ignore-existing localminio/torus-xapi"
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml exec minio /bin/sh -c "mc alias set localminio http://localhost:9000 minio-user minio-password && mc mb --ignore-existing localminio/torus-blob-dev"

          # Set minio bucket policies
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml exec minio /bin/sh -c "mc alias set localminio http://localhost:9000 minio-user minio-password && mc anonymous set public localminio/torus-media"
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml exec minio /bin/sh -c "mc alias set localminio http://localhost:9000 minio-user minio-password && mc anonymous set public localminio/torus-xapi"
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml exec minio /bin/sh -c "mc alias set localminio http://localhost:9000 minio-user minio-password && mc anonymous set public localminio/torus-blob-dev"

          # Run deployment
          docker-compose -p $DEPLOYMENT -f devops/docker-compose.yml up -d

      - name: ‚è≥ Wait for deployment to become available
        if: steps.preflight.outputs.memory_insufficient != 'true'
        run: |
          export HOST=pr${{ github.event.number }}.plasma.oli.cmu.edu
          for i in {1..30}; do
            if curl -k -fsSL --max-time 5 https://$HOST/healthz; then
              echo "Deployment is up!"
              exit 0
            fi
            echo "Waiting for deployment to be available... ($i)"
            sleep 10
          done
          echo "Deployment did not become available in time." >&2
          exit 1

      - name: üîç Find existing PR preview comment
        if: steps.preflight.outputs.memory_insufficient != 'true' && github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          token: ${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}
          issue-number: ${{ github.event.number }}
          comment-author: "simon-bot"
          body-includes: "PR preview deployed at:"

      - name: üí¨ Post/Update PR Preview URL Comment
        if: steps.preflight.outputs.memory_insufficient != 'true' && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.SIMON_BOT_PERSONAL_ACCESS_TOKEN }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          body: |
            PR preview deployed at: https://pr${{ github.event.number }}.plasma.oli.cmu.edu
          edit-mode: replace
