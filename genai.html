<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="OLI Torus v0.32.0">


    <title>GenAI Infrastructure: Design and Implementation — OLI Torus v0.32.0</title>

    <link rel="stylesheet" href="dist/html-elixir-KV3YOVJ3.css" />

    <script defer src="dist/sidebar_items-A2124E1D.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="http://oli.cmu.edu" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="OLI Torus" />
        </a>

      <div>
        <a href="http://oli.cmu.edu" class="sidebar-projectName" translate="no">
OLI Torus
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.32.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras="GUIDES"></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of OLI Torus</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>GenAI Infrastructure: Design and Implementation</h1>


      <a href="https://github.com/Simon-Initiative/oli-torus/blob/main/guides/design/genai.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This document describes the design and operation of the GenAI infrastructure within Torus. This infrastructure provides flexible, runtime-configurable support for integrating multiple GenAI models from various providers, enabling features to leverage different models depending on system-level or course-section-level configurations.</p><h2 id="key-capabilities" class="section-heading"><a href="#key-capabilities" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Capabilities</span></h2><p>The GenAI infrastructure is designed with several core capabilities:</p><ul><li><strong>Dynamic Model Integration</strong>: Runtime support for registering and utilizing models from multiple providers, including OpenAI, Claude, or any provider with an OpenAI-compliant API.</li><li><strong>Feature-Specific Model Usage</strong>: Different GenAI features within Torus can independently use different registered models.</li><li><strong>Course-Section-Level Customization</strong>: The ability to override default models at the individual course section level.</li><li><strong>Fallback Mechanism</strong>: Robust handling of provider errors through a backup model configuration, ensuring system reliability.</li><li><strong>Reusable Dialogue Implementation</strong>: A clean, modular GenServer-based dialogue component suitable for use across multiple features.</li></ul><h2 id="architectural-components" class="section-heading"><a href="#architectural-components" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architectural Components</span></h2><h3 id="completions-service-and-provider-behavior" class="section-heading"><a href="#completions-service-and-provider-behavior" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Completions Service and Provider Behavior</span></h3><p>The core interface for interacting with GenAI models is the <a href="Oli.GenAI.Completions.html"><code class="inline">Oli.GenAI.Completions</code></a> service. This module dynamically dispatches completion requests through its <code class="inline">generate/3</code> and <code class="inline">stream/4</code> functions to specific provider implementations based on configuration.</p><p>Three provider implementations currently exist:</p><ul><li><a href="Oli.GenAI.Completions.OpenAICompliantProvider.html"><code class="inline">Oli.GenAI.Completions.OpenAICompliantProvider</code></a></li><li><a href="Oli.GenAI.Completions.ClaudeProvider.html"><code class="inline">Oli.GenAI.Completions.ClaudeProvider</code></a></li><li><a href="Oli.GenAI.Completions.NullProvider.html"><code class="inline">Oli.GenAI.Completions.NullProvider</code></a> (a placeholder used for development and testing)</li></ul><h3 id="registered-models" class="section-heading"><a href="#registered-models" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Registered Models</span></h3><p>Models from GenAI providers are represented within the system using the <code class="inline">RegisteredModel</code> schema. This schema captures essential details such as provider type, model name, and the API endpoint (<code class="inline">url_template</code>). Administrators will be able to dynamically register new models via an upcoming administrative interface.</p><p>Example registrations:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="8987866557-1">%</span><span class="nc" data-group-id="8987866557-1">RegisteredModel</span><span class="p" data-group-id="8987866557-1">{</span><span class="ss">provider</span><span class="p">:</span><span class="w"> </span><span class="ss">:openai</span><span class="p">,</span><span class="w"> </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-4-1106-preview&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">url_template</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.openai.com&quot;</span><span class="p" data-group-id="8987866557-1">}</span><span class="w">
</span><span class="p" data-group-id="8987866557-2">%</span><span class="nc" data-group-id="8987866557-2">RegisteredModel</span><span class="p" data-group-id="8987866557-2">{</span><span class="ss">provider</span><span class="p">:</span><span class="w"> </span><span class="ss">:openai</span><span class="p">,</span><span class="w"> </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-4.5-preview-2025-02-27&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">url_template</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.openai.com&quot;</span><span class="p" data-group-id="8987866557-2">}</span><span class="w">
</span><span class="p" data-group-id="8987866557-3">%</span><span class="nc" data-group-id="8987866557-3">RegisteredModel</span><span class="p" data-group-id="8987866557-3">{</span><span class="ss">provider</span><span class="p">:</span><span class="w"> </span><span class="ss">:claude</span><span class="p">,</span><span class="w"> </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;claude-3-haiku-20240307&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">url_template</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.anthropic.com&quot;</span><span class="p" data-group-id="8987866557-3">}</span><span class="w">
</span><span class="p" data-group-id="8987866557-4">%</span><span class="nc" data-group-id="8987866557-4">RegisteredModel</span><span class="p" data-group-id="8987866557-4">{</span><span class="ss">provider</span><span class="p">:</span><span class="w"> </span><span class="ss">:openai</span><span class="p">,</span><span class="w"> </span><span class="ss">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-fine-tuned-gemini&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">url_template</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://server.undermydesk.com&quot;</span><span class="p" data-group-id="8987866557-4">}</span></code></pre><p>The infrastructure supports integration of official foundation models and self-hosted or fine-tuned solutions seamlessly.</p><h3 id="service-configuration-serviceconfig" class="section-heading"><a href="#service-configuration-serviceconfig" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Service Configuration (<code class="inline">ServiceConfig</code>)</span></h3><p>Each GenAI-driven feature in Torus is configured through a <code class="inline">ServiceConfig</code>. A service configuration defines a primary registered model to use for a feature and can optionally specify a backup model as a fallback. This ensures graceful degradation of service if the primary provider becomes unavailable or returns an error.</p><h3 id="feature-level-configuration-genaifeatureconfig" class="section-heading"><a href="#feature-level-configuration-genaifeatureconfig" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Feature-Level Configuration (<code class="inline">GenAIFeatureConfig</code>)</span></h3><p>The GenAIFeatureConfig schema associates GenAI-powered features (like student dialogue or instructor dashboards) with specific ServiceConfig instances. It allows setting a global default for each feature, with the option for individual course sections to override this default.</p><p>The schema is straightforward:</p><pre><code class="makeup elixir" translate="no"><span class="n">schema</span><span class="w"> </span><span class="s">&quot;gen_ai_feature_configs&quot;</span><span class="w"> </span><span class="k" data-group-id="7327283683-1">do</span><span class="w">
  </span><span class="n">field</span><span class="p" data-group-id="7327283683-2">(</span><span class="ss">:feature</span><span class="p">,</span><span class="w"> </span><span class="nc">Ecto.Enum</span><span class="p">,</span><span class="w"> </span><span class="ss">values</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7327283683-3">[</span><span class="ss">:student_dialogue</span><span class="p">,</span><span class="w"> </span><span class="ss">:instructor_dashboard</span><span class="p" data-group-id="7327283683-3">]</span><span class="p" data-group-id="7327283683-2">)</span><span class="w">
  </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:service_config</span><span class="p">,</span><span class="w"> </span><span class="nc">Oli.GenAI.Completions.ServiceConfig</span><span class="w">
  </span><span class="n">belongs_to</span><span class="w"> </span><span class="ss">:section</span><span class="p">,</span><span class="w"> </span><span class="nc">Oli.Delivery.Sections.Section</span><span class="w">

  </span><span class="n">timestamps</span><span class="p" data-group-id="7327283683-4">(</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:utc_datetime</span><span class="p" data-group-id="7327283683-4">)</span><span class="w">
</span><span class="k" data-group-id="7327283683-1">end</span></code></pre><p>For instance, the system might define a global default where the student dialogue feature (<code class="inline">:student_dialogue</code>) uses OpenAI's GPT-4 by default, with a Claude model as a fallback. A specific course section (e.g., REAL CHEM) could then override this to use a fine-tuned Gemini model, specifying OpenAI as the backup.</p><p>When a feature initializes (such as the DOT component), it retrieves both the global default and any section-specific configuration. It prioritizes the section-specific configuration, falling back to the global default as necessary.</p><h3 id="dialogue-management-via-genserver-oli-genai-dialogue-server" class="section-heading"><a href="#dialogue-management-via-genserver-oli-genai-dialogue-server" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Dialogue Management via GenServer (<a href="Oli.GenAI.Dialogue.Server.html"><code class="inline">Oli.GenAI.Dialogue.Server</code></a>)</span></h3><p>The multi-turn dialogue implementation previously embedded within UI components has been extracted into a standalone GenServer (Oli.GenAI.Dialogue.Server). This GenServer manages the lifecycle of GenAI dialogues—processing messages, handling streaming responses from GenAI providers, and dispatching tokens back to UI processes (typically Phoenix LiveView components). This modular design allows easy reuse and maintains a clear separation of concerns.</p><h3 id="database-initialization-and-environment-variables" class="section-heading"><a href="#database-initialization-and-environment-variables" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Database Initialization and Environment Variables</span></h3><p>When setting up or resetting the database (mix ecto.reset), migrations automatically detect environment variables for API keys (OpenAI and Anthropic). If these keys are present, appropriate RegisteredModel and ServiceConfig records are created. If absent, the system defaults to using the NullProvider, which provides basic responses for development purposes.</p><p>This design ensures that in production environments (such as Proton or Stellarator), real provider configurations will automatically be established, whereas in local or development setups, the system gracefully defaults to a no-operation provider.</p><h3 id="planned-enhancements" class="section-heading"><a href="#planned-enhancements" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Planned Enhancements</span></h3><p>The present design deliberately maintains backward compatibility. Deploying this infrastructure will not affect previous GenAI functionality, as default configurations replicate existing behavior, with new capabilities becoming available incrementally as administrators and course authors configure them through the forthcoming UI.</p><p>Future features (instructor facing DOT, authoring agent) will add new entries into the <a href="https://hexdocs.pm/ecto/3.13.2/Ecto.Enum.html"><code class="inline">Ecto.Enum</code></a> of <code class="inline">:features</code> in the <code class="inline">GenAIFeatureConfig</code> schema and default <code class="inline">ServiceConfig</code> references.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="locking.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Document locking
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="page-model.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Page model
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="OLI Torus.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
