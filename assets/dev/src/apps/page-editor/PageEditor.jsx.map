{"version":3,"file":"PageEditor.jsx","sourceRoot":"","sources":["../../../../src/apps/page-editor/PageEditor.tsx"],"names":[],"mappings":"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","sourcesContent":["import { MultiInputSchema } from 'components/activities/multi_input/schema';\nimport { guaranteeMultiInputValidity } from 'components/activities/multi_input/utils';\nimport { ActivityModelSchema, Undoable as ActivityUndoable } from 'components/activities/types';\nimport { EditorUpdate as ActivityEditorUpdate } from 'components/activity/InlineActivityEditor';\nimport { PersistenceStatus } from 'components/content/PersistenceStatus';\nimport { TitleBar } from 'components/content/TitleBar';\nimport { Banner } from 'components/messages/Banner';\nimport { Editors } from 'components/resource/editors/Editors';\nimport { UndoToasts } from 'components/resource/undo/UndoToasts';\nimport { ActivityEditContext } from 'data/content/activity';\nimport { guaranteeValididty } from 'data/content/bank';\nimport { ActivityEditorMap } from 'data/content/editors';\nimport { Objective } from 'data/content/objective';\nimport {\n  ActivityMap,\n  ActivityReference,\n  createDefaultStructuredContent,\n  ResourceContent,\n  ResourceContext,\n  StructuredContent,\n} from 'data/content/resource';\nimport { Tag } from 'data/content/tags';\nimport { createMessage, Message, Severity } from 'data/messages/messages';\nimport * as ActivityPersistence from 'data/persistence/activity';\nimport { DeferredPersistenceStrategy } from 'data/persistence/DeferredPersistenceStrategy';\nimport { acquireLock, NotAcquired, releaseLock } from 'data/persistence/lock';\nimport { PersistenceStrategy } from 'data/persistence/PersistenceStrategy';\nimport * as Persistence from 'data/persistence/resource';\nimport { ProjectSlug, ResourceId, ResourceSlug } from 'data/types';\nimport * as Immutable from 'immutable';\nimport React from 'react';\nimport { connect } from 'react-redux';\nimport { Dispatch, State } from 'state';\nimport { loadPreferences } from 'state/preferences';\nimport guid from 'utils/guid';\nimport { Operations } from 'utils/pathOperations';\nimport { registerUnload, unregisterUnload } from './listeners';\nimport './PageEditor.scss';\nimport { empty, PageUndoable, Undoables } from './types';\n\nexport interface PageEditorProps extends ResourceContext {\n  editorMap: ActivityEditorMap; // Map of activity types to activity elements\n  activities: ActivityMap;\n  onLoadPreferences: () => void;\n}\n\n// The changes that the editor can make\ntype EditorUpdate = {\n  title: string;\n  content: Immutable.OrderedMap<string, ResourceContent>;\n  objectives: Immutable.List<ResourceId>;\n};\n\ntype PageEditorState = {\n  messages: Message[];\n  title: string;\n  content: Immutable.OrderedMap<string, ResourceContent>;\n  activityContexts: Immutable.OrderedMap<string, ActivityEditContext>;\n  objectives: Immutable.List<ResourceId>;\n  allObjectives: Immutable.List<Objective>;\n  allTags: Immutable.List<Tag>;\n  childrenObjectives: Immutable.Map<ResourceId, Immutable.List<Objective>>;\n  editMode: boolean;\n  persistence: 'idle' | 'pending' | 'inflight';\n  undoables: Undoables;\n};\n\n// Creates a function that when invoked submits a save request\nfunction prepareSaveFn(\n  project: ProjectSlug,\n  resource: ResourceSlug,\n  update: Persistence.ResourceUpdate,\n) {\n  return (releaseLock: boolean) =>\n    Persistence.edit(project, resource, update, releaseLock).then((result) => {\n      // check if the slug has changed as a result of the edit and reload the page if it has\n      if (result.type === 'success' && result.revision_slug !== resource) {\n        window.location.replace(`/authoring/project/${project}/resource/${result.revision_slug}`);\n        return result;\n      }\n      return result;\n    });\n}\n\n// Ensures that there is some default content if the initial content\n// of this resource is empty\nfunction withDefaultContent(\n  content: (StructuredContent | ActivityReference)[],\n): [string, ResourceContent][] {\n  if (content.length > 0) {\n    return content.map((contentItem) => {\n      // There is the possibility that ingested course material did not specify the\n      // id attribute. If so, we will assign one here that will get persisted once the user\n      // edits the page.\n      contentItem =\n        contentItem.id === undefined ? Object.assign({}, contentItem, { id: guid() }) : contentItem;\n      return [contentItem.id, contentItem];\n    });\n  }\n  const defaultContent = createDefaultStructuredContent();\n  return [[defaultContent.id, defaultContent]];\n}\n\nfunction mapChildrenObjectives(\n  objectives: Objective[],\n): Immutable.Map<ResourceId, Immutable.List<Objective>> {\n  return objectives.reduce((map, o) => {\n    if (o.parentId !== null) {\n      let updatedMap = map;\n      if (o.parentId !== null && !map.has(o.parentId)) {\n        updatedMap = updatedMap.set(o.parentId, Immutable.List());\n      }\n      const appended = (updatedMap.get(o.parentId) as any).push(o);\n      return updatedMap.set(o.parentId, appended);\n    }\n    return map;\n  }, Immutable.Map<ResourceId, Immutable.List<Objective>>());\n}\n\n// The resource editor\nexport class PageEditor extends React.Component<PageEditorProps, PageEditorState> {\n  persistence: PersistenceStrategy;\n  activityPersistence: { [id: string]: PersistenceStrategy };\n  windowUnloadListener: any;\n  undoRedoListener: any;\n  keydownListener: any;\n  keyupListener: any;\n  mousedownListener: any;\n  mouseupListener: any;\n  windowBlurListener: any;\n\n  constructor(props: PageEditorProps) {\n    super(props);\n\n    const { title, objectives, allObjectives, content, allTags } = props;\n\n    const activityContexts = Immutable.OrderedMap<string, ActivityEditContext>(\n      this.props.activityContexts.map((c) => {\n        return [c.activitySlug, c];\n      }),\n    );\n\n    this.state = {\n      activityContexts,\n      messages: [],\n      editMode: false,\n      title,\n      allTags: Immutable.List<Tag>(allTags),\n      objectives: Immutable.List<ResourceId>(objectives.attached),\n      content: Immutable.OrderedMap<string, ResourceContent>(\n        withDefaultContent(content.model as any),\n      ),\n      persistence: 'idle',\n      allObjectives: Immutable.List<Objective>(allObjectives),\n      childrenObjectives: mapChildrenObjectives(allObjectives),\n      undoables: empty(),\n    };\n\n    this.persistence = new DeferredPersistenceStrategy();\n\n    this.update = this.update.bind(this);\n    this.onActivityEdit = this.onActivityEdit.bind(this);\n    this.onPostUndoable = this.onPostUndoable.bind(this);\n    this.onInvokeUndo = this.onInvokeUndo.bind(this);\n  }\n\n  componentDidMount() {\n    const { projectSlug, resourceSlug, onLoadPreferences } = this.props;\n\n    onLoadPreferences();\n\n    this.persistence\n      .initialize(\n        acquireLock.bind(undefined, projectSlug, resourceSlug),\n        releaseLock.bind(undefined, projectSlug, resourceSlug),\n        // eslint-disable-next-line\n        () => {},\n        (failure) => this.publishErrorMessage(failure),\n        (persistence) => this.setState({ persistence }),\n      )\n      .then((editMode) => {\n        this.setState({ editMode });\n        if (editMode) {\n          this.initActivityPersistence();\n          this.windowUnloadListener = registerUnload(this.persistence);\n        } else if (this.persistence.getLockResult().type === 'not_acquired') {\n          const notAcquired: NotAcquired = this.persistence.getLockResult() as NotAcquired;\n          this.editingLockedMessage(notAcquired.user);\n        }\n      });\n\n    if (window.location.hash !== '') {\n      const e = document.getElementById(window.location.hash.substr(1));\n      if (e !== null) {\n        e.scrollIntoView();\n      }\n    }\n  }\n\n  componentWillUnmount() {\n    this.persistence.destroy();\n\n    unregisterUnload(this.windowUnloadListener);\n  }\n\n  initActivityPersistence() {\n    this.activityPersistence = Object.keys(this.state.activityContexts.toObject()).reduce(\n      (map, key) => {\n        const activity: ActivityEditContext = this.state.activityContexts.get(\n          key,\n        ) as ActivityEditContext;\n\n        const persistence = new DeferredPersistenceStrategy();\n        persistence.initialize(\n          () => Promise.resolve({ type: 'acquired' }),\n          () => Promise.resolve({ type: 'acquired' }),\n          // eslint-disable-next-line\n          () => {},\n          (failure) => this.publishErrorMessage(failure),\n          (persistence) => this.setState({ persistence }),\n        );\n\n        (map as any)[activity.activitySlug] = persistence;\n        return map;\n      },\n      {},\n    );\n  }\n\n  editingLockedMessage(email: string) {\n    const message = createMessage({\n      guid: 'readonly-error',\n      canUserDismiss: false,\n      content: 'Read Only. User ' + email + ' is currently editing this page.',\n      severity: Severity.Information,\n    });\n    this.addAsUnique(message);\n  }\n\n  publishErrorMessage(failure: any) {\n    let message;\n    switch (failure?.status) {\n      case 423:\n        message = 'refresh the page to re-gain edit access.';\n        break;\n      case 404:\n        message = 'this page was not found. Try reopening it from the Curriculum.';\n        break;\n      case 403:\n        message = \"you're not able to access this page. Did your login expire?\";\n        break;\n      case 500:\n      default:\n        message =\n          // tslint:disable-next-line\n          'there was a general problem on our end. Please try refreshing the page and trying again.';\n        break;\n    }\n\n    this.addAsUnique(\n      createMessage({\n        guid: 'general-error',\n        canUserDismiss: true,\n        content: \"Your changes weren't saved: \" + message,\n      }),\n    );\n  }\n\n  onActivityEdit(key: string, update: ActivityEditorUpdate): void {\n    const model = this.adjustActivityForConstraints(\n      this.state.activityContexts.get(key)?.typeSlug,\n      update.content,\n    );\n    const withModel = {\n      model: update.content,\n      title: update.title,\n      objectives: update.objectives,\n      tags: update.tags,\n    };\n    // apply the edit\n    const merged = Object.assign({}, this.state.activityContexts.get(key), withModel);\n    const activityContexts = this.state.activityContexts.set(key, merged);\n\n    this.setState({ activityContexts }, () => {\n      const saveFn = (releaseLock: boolean) =>\n        ActivityPersistence.edit(\n          this.props.projectSlug,\n          this.props.resourceId,\n          merged.activityId,\n          { ...update, content: model },\n          releaseLock,\n        );\n\n      this.activityPersistence[key].save(saveFn);\n    });\n  }\n\n  onRemove(key: string) {\n    const item = this.state.content.get(key);\n    const index = this.state.content.toArray().findIndex(([k, _item]) => k === key);\n\n    if (item !== undefined) {\n      const undoable: PageUndoable = {\n        type: 'PageUndoable',\n        description: 'Removed ' + (item.type === 'content' ? 'Content' : 'Activity'),\n        index,\n        item,\n      };\n\n      const content = this.state.content.delete(key);\n      this.update({ content });\n      this.onPostUndoable(key, undoable);\n    }\n  }\n\n  onPostUndoable(key: string, undoable: ActivityUndoable | PageUndoable) {\n    const id = guid();\n    this.setState(\n      {\n        undoables: this.state.undoables.set(id, {\n          guid: id,\n          contentKey: key,\n          undoable,\n        }),\n      },\n      () =>\n        setTimeout(\n          () =>\n            this.setState({\n              undoables: this.state.undoables.delete(id),\n            }),\n          5000,\n        ),\n    );\n  }\n\n  onInvokeUndo(guid: string) {\n    const item = this.state.undoables.get(guid);\n\n    if (item !== undefined) {\n      if (item.undoable.type === 'PageUndoable') {\n        const content = this.state.content.toArray();\n        content.splice(item.undoable.index, 0, [item.contentKey, item.undoable.item]);\n        this.update({ content: Immutable.OrderedMap<string, ResourceContent>(content) });\n      } else {\n        const context = this.state.activityContexts.get(item.contentKey);\n        if (context !== undefined) {\n          // Perform a deep copy\n          const model = JSON.parse(JSON.stringify(context.model));\n\n          // Apply the undo operations to the model\n          Operations.applyAll(model as any, item.undoable.operations);\n\n          // Now save the change and push it down to the activity editor\n          this.onActivityEdit(item.contentKey, {\n            content: model,\n            title: context.title,\n            objectives: context.objectives,\n            tags: context.tags,\n          });\n        }\n      }\n    }\n\n    this.setState({ undoables: this.state.undoables.delete(guid) });\n  }\n\n  createObjectiveErrorMessage(_failure: any) {\n    const message = createMessage({\n      guid: 'objective-error',\n      canUserDismiss: true,\n      content: 'A problem occurred while creating your new objective',\n      severity: Severity.Error,\n    });\n    this.addAsUnique(message);\n  }\n\n  addAsUnique(message: Message) {\n    const messages = this.state.messages.filter((m) => m.guid !== message.guid);\n    this.setState({ messages: [...messages, message] });\n  }\n\n  update(update: Partial<EditorUpdate>) {\n    const mergedState = Object.assign({}, this.state, update);\n    this.setState(mergedState, () => this.save());\n  }\n\n  updateImmediate(update: Partial<EditorUpdate>) {\n    const mergedState = Object.assign({}, this.state, update);\n    this.setState(mergedState, () => this.saveImmediate());\n  }\n\n  // Makes any modifications necessary to adhere to a set of constraints that the server\n  // uses to define \"valid page content\"\n  //\n  // The only adjustment made currently is to manipulate bank selections to ensure that they will be\n  // valid queries.\n  //\n  // Adjustments are made in a way that does not push down the results back to the component\n  // tree as updated props, rather, they are made inline just prior to scheduling an update\n  // of content to be saved.  In this manner, we allow the user interface to display invalid, intermediate\n  // states (as the user is creating a selection, for instance) that will always be saved\n  // as valid states.\n  adjustContentForConstraints(\n    content: Immutable.OrderedMap<string, ResourceContent>,\n  ): ResourceContent[] {\n    const arr = content.toArray();\n\n    return arr.map((v: any) => {\n      const e = v[1];\n      if (e.type === 'selection') {\n        return Object.assign({}, e, { logic: guaranteeValididty(e.logic) });\n      }\n      return e;\n    });\n  }\n\n  adjustActivityForConstraints(\n    activityType: string | undefined,\n    model: ActivityModelSchema,\n  ): ActivityModelSchema {\n    if (activityType === 'oli_multi_input') {\n      return guaranteeMultiInputValidity(model as MultiInputSchema);\n    }\n    return model;\n  }\n\n  save() {\n    const { projectSlug, resourceSlug } = this.props;\n\n    const model = this.adjustContentForConstraints(this.state.content);\n\n    const toSave: Persistence.ResourceUpdate = {\n      objectives: { attached: this.state.objectives.toArray() },\n      title: this.state.title,\n      content: { model },\n      releaseLock: false,\n    };\n\n    this.persistence.save(prepareSaveFn(projectSlug, resourceSlug, toSave));\n  }\n\n  saveImmediate() {\n    const { projectSlug, resourceSlug } = this.props;\n\n    const toSave: Persistence.ResourceUpdate = {\n      objectives: { attached: this.state.objectives.toArray() },\n      title: this.state.title,\n      content: { model: this.state.content.toArray().map(([_k, v]) => v) },\n      releaseLock: false,\n    };\n\n    this.persistence.saveImmediate(prepareSaveFn(projectSlug, resourceSlug, toSave));\n  }\n\n  render() {\n    const props = this.props;\n    const state = this.state;\n\n    const { projectSlug, resourceSlug } = this.props;\n\n    const onEdit = (content: Immutable.OrderedMap<string, ResourceContent>) => {\n      this.update({ content });\n    };\n\n    const onTitleEdit = (title: string) => {\n      this.updateImmediate({ title });\n    };\n\n    const onAddItem = (\n      c: StructuredContent | ActivityReference,\n      index: number,\n      a?: ActivityEditContext,\n    ) => {\n      this.update({\n        content: this.state.content\n          .take(index)\n          .concat([[c.id, c]])\n          .concat(this.state.content.skip(index)),\n      });\n      if (a) {\n        const persistence = new DeferredPersistenceStrategy();\n        persistence.initialize(\n          () => Promise.resolve({ type: 'acquired' }),\n          () => Promise.resolve({ type: 'acquired' }),\n          // eslint-disable-next-line\n          () => {},\n          (failure) => this.publishErrorMessage(failure),\n          (persistence) => this.setState({ persistence }),\n        );\n        this.activityPersistence[a.activitySlug] = persistence;\n\n        this.setState({ activityContexts: this.state.activityContexts.set(a.activitySlug, a) });\n      }\n    };\n\n    const onRegisterNewObjective = (objective: Objective) => {\n      this.setState({\n        allObjectives: this.state.allObjectives.push(objective),\n        childrenObjectives: this.state.childrenObjectives.set(\n          objective.id,\n          Immutable.List<Objective>(),\n        ),\n      });\n    };\n\n    const onRegisterNewTag = (tag: Tag) => {\n      this.setState({\n        allTags: this.state.allTags.push(tag),\n      });\n    };\n\n    const isSaving = this.state.persistence === 'inflight' || this.state.persistence === 'pending';\n\n    const PreviewButton = () => (\n      <a\n        className={`btn btn-sm btn-outline-primary ml-3 ${isSaving ? 'disabled' : ''}`}\n        onClick={() =>\n          window.open(\n            `/authoring/project/${projectSlug}/preview/${resourceSlug}`,\n            `preview-${projectSlug}`,\n          )\n        }\n      >\n        Preview <i className=\"las la-external-link-alt ml-1\"></i>\n      </a>\n    );\n\n    return (\n      <div className=\"resource-editor row\">\n        <div className=\"col-12\">\n          <UndoToasts undoables={this.state.undoables} onInvokeUndo={this.onInvokeUndo} />\n\n          <Banner\n            dismissMessage={(msg: any) =>\n              this.setState({ messages: this.state.messages.filter((m) => msg.guid !== m.guid) })\n            }\n            executeAction={(message: any, action: any) => action.execute(message)}\n            messages={this.state.messages}\n          />\n          <TitleBar title={state.title} onTitleEdit={onTitleEdit} editMode={this.state.editMode}>\n            <PersistenceStatus persistence={this.state.persistence} />\n\n            <PreviewButton />\n          </TitleBar>\n          <div>\n            <Editors\n              {...props}\n              editMode={this.state.editMode}\n              objectives={this.state.allObjectives}\n              allTags={this.state.allTags}\n              childrenObjectives={this.state.childrenObjectives}\n              onRegisterNewObjective={onRegisterNewObjective}\n              onRegisterNewTag={onRegisterNewTag}\n              activityContexts={this.state.activityContexts}\n              onRemove={(key: string) => this.onRemove(key)}\n              onEdit={(c: any, key: string) => onEdit(this.state.content.set(key, c))}\n              onEditContentList={onEdit}\n              onActivityEdit={this.onActivityEdit}\n              onPostUndoable={this.onPostUndoable}\n              content={this.state.content}\n              onAddItem={onAddItem}\n              resourceContext={props}\n            />\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n\n// eslint-disable-next-line\ninterface StateProps {}\n\ninterface DispatchProps {\n  onLoadPreferences: () => void;\n}\n\ntype OwnProps = {\n  editorMap: ActivityEditorMap;\n  activities: ActivityMap;\n};\n\nconst mapStateToProps = (_state: State, _ownProps: OwnProps): StateProps => {\n  return {};\n};\n\nconst mapDispatchToProps = (dispatch: Dispatch, _ownProps: OwnProps): DispatchProps => {\n  return {\n    onLoadPreferences: () => dispatch(loadPreferences()),\n  };\n};\n\nexport default connect<StateProps, DispatchProps, OwnProps>(\n  mapStateToProps,\n  mapDispatchToProps,\n)(PageEditor);\n"]}