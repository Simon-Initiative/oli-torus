{"version":3,"file":"PartComponent.jsx","sourceRoot":"","sources":["../../../../../../../src/components/activities/adaptive/components/common/PartComponent.tsx"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable react/prop-types */\nimport {\n  AuthorPartComponentProps,\n  CustomProperties,\n  PartComponentProps,\n} from 'components/parts/types/parts';\nimport React, { CSSProperties, useContext, useEffect, useRef, useState, useCallback } from 'react';\nimport {\n  NotificationContext,\n  NotificationType,\n  subscribeToNotification,\n} from '../../../../../apps/delivery/components/NotificationContext';\nimport { tagName as UnknownTag } from './UnknownPart';\n\nconst stubHandler = async () => {\n  return;\n};\n\ntype AuthorProps = AuthorPartComponentProps<CustomProperties>;\ntype DeliveryProps = PartComponentProps<CustomProperties>;\n\nconst PartComponent: React.FC<AuthorProps | DeliveryProps> = (props) => {\n  const pusherContext = useContext(NotificationContext);\n  const initialStyles: CSSProperties = {\n    display: 'block',\n    position: 'absolute',\n    top: props.model.y,\n    left: props.model.x,\n    zIndex: props.model.z || 0,\n  };\n\n  const [componentStyle, setComponentStyle] = useState<CSSProperties>(initialStyles);\n\n  const [customCssClass, setCustomCssClass] = useState<string>(props.model.customCssClass || '');\n\n  const handleStylingChanges = (currentStateSnapshot: Record<string, unknown>) => {\n    const styleChanges: CSSProperties = {};\n    const sX = currentStateSnapshot[`stage.${props.id}.IFRAME_frameX`];\n    if (sX !== undefined) {\n      styleChanges.left = sX as number;\n    }\n\n    const sY = currentStateSnapshot[`stage.${props.id}.IFRAME_frameY`];\n    if (sY !== undefined) {\n      styleChanges.top = sY as number;\n    }\n\n    const sZ = currentStateSnapshot[`stage.${props.id}.IFRAME_frameZ`];\n    if (sZ !== undefined) {\n      styleChanges.zIndex = sZ as number;\n    }\n\n    const sWidth = currentStateSnapshot[`stage.${props.id}.IFRAME_frameWidth`];\n    if (sWidth !== undefined) {\n      styleChanges.width = sWidth as number;\n    }\n\n    const sHeight = currentStateSnapshot[`stage.${props.id}.IFRAME_frameHeight`];\n    if (sHeight !== undefined) {\n      styleChanges.height = sHeight as number;\n    }\n    setComponentStyle((previousStyle) => {\n      return { ...previousStyle, ...styleChanges };\n    });\n\n    const sCssClass = currentStateSnapshot[`stage.${props.id}.IFRAME_frameCssClass`];\n    if (sCssClass !== undefined) {\n      setCustomCssClass(sCssClass as string);\n    }\n\n    const sCustomCssClass = currentStateSnapshot[`stage.${props.id}.customCssClass`];\n    if (sCustomCssClass !== undefined) {\n      setCustomCssClass(sCustomCssClass as string);\n    }\n  };\n\n  const onResize = useCallback(\n    async (payload: any) => {\n      const settings = payload.settings;\n      const styleChanges: CSSProperties = {};\n\n      if (settings?.width) {\n        styleChanges.width = settings.width.value;\n      }\n\n      if (settings?.height) {\n        styleChanges.height = settings.height.value;\n      }\n\n      if (settings?.zIndex) {\n        const newZ = settings.zIndex.value;\n        styleChanges.zIndex = newZ;\n      }\n      setComponentStyle((previousStyle) => {\n        return { ...previousStyle, ...styleChanges };\n      });\n      return true;\n    },\n    [componentStyle],\n  );\n\n  const [wcEvents, setWcEvents] = useState<Record<string, (payload: any) => Promise<any>>>({\n    init: props.onInit,\n    ready: props.onReady,\n    save: props.onSave,\n    submit: props.onSubmit,\n    resize: props.onResize,\n    getData: props.onGetData || stubHandler,\n    setData: props.onSetData || stubHandler,\n    // authoring\n    configure: (props as AuthorProps).onConfigure || stubHandler,\n    saveconfigure: (props as AuthorProps).onSaveConfigure || stubHandler,\n    cancelconfigure: (props as AuthorProps).onCancelConfigure || stubHandler,\n  });\n\n  useEffect(() => {\n    setWcEvents({\n      init: props.onInit,\n      ready: props.onReady,\n      save: props.onSave,\n      submit: props.onSubmit,\n      resize: props.onResize,\n      getData: props.onGetData || stubHandler,\n      setData: props.onSetData || stubHandler,\n\n      // authoring\n      configure: (props as AuthorProps).onConfigure || stubHandler,\n      saveconfigure: (props as AuthorProps).onSaveConfigure || stubHandler,\n      cancelconfigure: (props as AuthorProps).onCancelConfigure || stubHandler,\n    });\n  }, [\n    props.onInit,\n    props.onReady,\n    props.onSave,\n    props.onSubmit,\n    props.onResize,\n    props.onGetData,\n    props.onSetData,\n    (props as AuthorProps).onConfigure,\n    (props as AuthorProps).onSaveConfigure,\n    (props as AuthorProps).onCancelConfigure,\n  ]);\n\n  const ref = useRef<any>(null);\n  useEffect(() => {\n    if (!pusherContext) {\n      return;\n    }\n    const notificationsHandled = [\n      NotificationType.CHECK_STARTED,\n      NotificationType.CHECK_COMPLETE,\n      NotificationType.CONTEXT_CHANGED,\n      NotificationType.STATE_CHANGED,\n      NotificationType.CONFIGURE,\n      NotificationType.CONFIGURE_SAVE,\n      NotificationType.CONFIGURE_CANCEL,\n    ];\n    const notifications = notificationsHandled.map((notificationType: NotificationType) => {\n      const handler = (e: any) => {\n        /* console.log(`${notificationType.toString()} notification handled [PC : ${props.id}]`, e); */\n        const el = ref.current;\n        if (el) {\n          if (el.notify) {\n            if (\n              notificationType === NotificationType.CONTEXT_CHANGED ||\n              notificationType === NotificationType.STATE_CHANGED\n            ) {\n              handleStylingChanges(e.snapshot || e.mutateChanges);\n            }\n            el.notify(notificationType.toString(), e);\n          }\n        }\n      };\n      const unsub = subscribeToNotification(pusherContext, notificationType, handler);\n      return unsub;\n    });\n    return () => {\n      notifications.forEach((unsub) => {\n        unsub();\n      });\n    };\n  }, [pusherContext]);\n\n  const [listening, setIsListening] = useState(false);\n\n  useEffect(() => {\n    const wcEventHandler = async (e: any) => {\n      const { payload, callback } = e.detail;\n      if (payload.id !== props.id) {\n        // because we need to listen to document we'll get all part component events\n        // each PC adds a listener, so we need to filter out our own here\n        return;\n      }\n      const handler = wcEvents[e.type];\n      if (handler) {\n        // TODO: refactor all handlers to take ID and send it here\n        const result = await handler(payload);\n        if (e.type === 'resize') {\n          onResize(payload);\n        }\n        if (callback) {\n          callback(result);\n        }\n      }\n    };\n    Object.keys(wcEvents).forEach((eventName) => {\n      document.addEventListener(eventName, wcEventHandler);\n    });\n    setIsListening(true);\n    return () => {\n      Object.keys(wcEvents).forEach((eventName) => {\n        document.removeEventListener(eventName, wcEventHandler);\n      });\n    };\n  }, [wcEvents, onResize]);\n\n  const webComponentProps: any = {\n    ref,\n    ...props,\n    model: JSON.stringify(props.model),\n    state: JSON.stringify(props.state),\n    customCssClass,\n  };\n\n  let wcTagName = props.type;\n  if (!wcTagName || !customElements.get(wcTagName)) {\n    wcTagName = UnknownTag;\n  }\n\n  // if we pass in style then it will be controlled and so nothing else can use it\n  if (!(props as AuthorProps).editMode) {\n    webComponentProps.style = componentStyle;\n    // console.log('DELIVERY RENDER:', wcTagName, props);\n  }\n\n  // don't render until we're listening because otherwise the init event will post too fast\n  return listening ? React.createElement(wcTagName, webComponentProps) : null;\n};\n\nexport default PartComponent;\n"]}