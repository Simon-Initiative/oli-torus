{"version":3,"file":"AdaptiveDelivery.jsx","sourceRoot":"","sources":["../../../../../src/components/activities/adaptive/AdaptiveDelivery.tsx"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport ReactDOM from 'react-dom';\nimport {\n  NotificationContext,\n  NotificationType,\n  subscribeToNotification,\n} from '../../../apps/delivery/components/NotificationContext';\nimport PartsLayoutRenderer from './components/delivery/PartsLayoutRenderer';\nimport { DeliveryElement, DeliveryElementProps } from '../DeliveryElement';\nimport * as ActivityTypes from '../types';\nimport { AdaptiveModelSchema } from './schema';\n\nconst sharedInitMap = new Map();\nconst sharedPromiseMap = new Map();\nconst sharedAttemptStateMap = new Map();\n\nconst Adaptive = (props: DeliveryElementProps<AdaptiveModelSchema>) => {\n  const {\n    content: { custom: config, partsLayout },\n  } = props.model;\n\n  const [pusher, setPusher] = useState(new EventEmitter().setMaxListeners(50));\n\n  // TODO: this type should be Environment | undefined; this is a local script env for each activity\n  // should be provided by the parent as a child env, possibly default to having its own instead\n  const [scriptEnv, setScriptEnv] = useState<any>();\n\n  const [adaptivityDomain, setAdaptivityDomain] = useState<string>('stage');\n\n  const parts = partsLayout || [];\n\n  const [init, setInit] = useState<boolean>(false);\n\n  useEffect(() => {\n    if (!props.notify) {\n      return;\n    }\n    const notificationsHandled = [\n      NotificationType.CHECK_STARTED,\n      NotificationType.CHECK_COMPLETE,\n      NotificationType.CONTEXT_CHANGED,\n      NotificationType.STATE_CHANGED,\n    ];\n    const notifications = notificationsHandled.map((notificationType: NotificationType) => {\n      const handler = (e: any) => {\n        /* console.log(`${notificationType.toString()} notification handled [AD]`, e); */\n        // here we need to check when the context changes (current activityId) if we are a layer\n        // (should only be possible as a layer, because other activities should be unloaded and loaded fresh)\n        // layers need to re-init the parts, BUT not re-render them (this is mostly for capi sims)\n        // because of the init promise is already resolved with the state snapshot it had the first time\n        // the layer rendered, the parts can't simply call init again or they will not get the latest changes\n        // still we just currently push notifications straight through, CONTEXT_CHANGED should have the latest snapshot\n\n        if (notificationType === NotificationType.CHECK_COMPLETE) {\n          // if the attempt was incorrect, then this will result in a new attempt record being generated\n          // if that is the case then the activity and all its parts need to update their guid references\n          const attempt = e.attempt;\n          const currentAttempt = sharedAttemptStateMap.get(props.model.id);\n          /* console.log('AD CHECK COMPLETE: ', {attempt, currentAttempt, props}); */\n          if (\n            attempt &&\n            currentAttempt &&\n            attempt.activityId === currentAttempt.activityId &&\n            attempt.attemptGuid !== currentAttempt.attemptGuid\n          ) {\n            /* console.log(\n              `ATTEMPT CHANGING from ${currentAttempt.attemptGuid} to ${attempt.attemptGuid}`,\n            ); */\n            sharedAttemptStateMap.set(props.model.id, attempt);\n            /* setAttemptState(attempt); */\n          }\n        }\n\n        pusher.emit(notificationType.toString(), e);\n      };\n      const unsub = subscribeToNotification(\n        props.notify as EventEmitter,\n        notificationType,\n        handler,\n      );\n      return unsub;\n    });\n    return () => {\n      /* console.log('AD UNSUB'); */\n      notifications.forEach((unsub) => {\n        unsub();\n      });\n    };\n  }, [props.notify]);\n\n  useEffect(() => {\n    let timeout: NodeJS.Timeout;\n    let resolve: any;\n    let reject;\n\n    if (!parts.length) {\n      if (props.onReady) {\n        props.onReady(props.state.attemptGuid);\n      }\n      setInit(true);\n      return;\n    }\n\n    const promise = new Promise((res, rej) => {\n      let resolved = false;\n      resolve = (value: any) => {\n        resolved = true;\n        res(value);\n      };\n      reject = (reason: string) => {\n        resolved = true;\n        rej(reason);\n      };\n      timeout = setTimeout(() => {\n        if (resolved) {\n          return;\n        }\n        console.error('[AllPartsInitialized] failed to resolve within time limit', {\n          timeout,\n          attemptState: props.state,\n          parts,\n        });\n      }, 2000);\n    });\n    sharedPromiseMap.set(props.model.id, { promise, resolve, reject });\n\n    sharedInitMap.set(\n      props.model.id,\n      parts.reduce((collect: Record<string, boolean>, part) => {\n        collect[part.id] = false;\n        return collect;\n      }, {}),\n    );\n\n    /* console.log('INIT AD', { props }); */\n    sharedAttemptStateMap.set(props.model.id, props.state);\n\n    setInit(true);\n\n    return () => {\n      clearTimeout(timeout);\n      sharedInitMap.delete(props.model.id);\n      sharedPromiseMap.delete(props.model.id);\n      sharedAttemptStateMap.delete(props.model.id);\n      setInit(false);\n    };\n  }, []);\n\n  const partInit = useCallback(\n    async (partId: string) => {\n      const currentAttemptState = sharedAttemptStateMap.get(props.model.id);\n      const partsInitStatus = sharedInitMap.get(props.model.id);\n      const partsInitDeferred = sharedPromiseMap.get(props.model.id);\n      partsInitStatus[partId] = true;\n      /* console.log(`%c INIT ${partId} CB`, 'background: blue;color:white;', {\n        parts,\n        partsInitStatus,\n      }); */\n      if (parts.every((part) => partsInitStatus[part.id] === true)) {\n        if (props.onReady) {\n          const readyResults: any = await props.onReady(currentAttemptState.attemptGuid);\n          const { env, domain } = readyResults;\n          if (env) {\n            setScriptEnv(env);\n          }\n          if (domain) {\n            setAdaptivityDomain(domain);\n          }\n          /* console.log('ACTIVITY READY RESULTS', readyResults); */\n          partsInitDeferred.resolve({\n            snapshot: readyResults.snapshot || {},\n            context: {\n              ...readyResults.context,\n              host: props.mountPoint,\n              domain: domain || adaptivityDomain,\n            },\n            env,\n          });\n        } else {\n          // if for some reason this isn't defined, don't leave it hanging\n          partsInitDeferred.resolve({\n            snapshot: {},\n            context: { mode: 'VIEWER', host: props.mountPoint },\n            env: scriptEnv,\n            domain: adaptivityDomain,\n          });\n        }\n      }\n      return partsInitDeferred.promise;\n    },\n    [parts, adaptivityDomain],\n  );\n\n  const handlePartInit = async (payload: { id: string | number; responses: any[] }) => {\n    /* console.log('onPartInit', payload); */\n    // a part should send initial state values\n    if (payload.responses.length) {\n      const saveResults = await handlePartSave(payload);\n    }\n\n    const { snapshot, context, env } = await partInit(payload.id.toString());\n    // TODO: something with save result? check for errors?\n    return { snapshot, context, env };\n  };\n\n  const handlePartReady = async (payload: { id: string | number }) => {\n    /* console.log('onPartReady', { payload }); */\n    return true;\n  };\n\n  const handlePartResize = async (payload: { id: string | number }) => {\n    // no need to do anything for now.\n    /*  console.log('handlePartResize called'); */\n    return true;\n  };\n\n  const handleSetData = async (payload: any) => {\n    const currentAttemptState = sharedAttemptStateMap.get(props.model.id);\n    // part attempt guid should be located in currentAttemptState.parts matched to id\n    const partAttempt = currentAttemptState.parts.find((p: any) => p.partId === payload.id);\n    if (!partAttempt) {\n      // throw err? if this happens we can't proceed...\n      console.error(`part attempt guid for ${payload.id} not found!`);\n      return;\n    }\n    if (props.onWriteUserState) {\n      await props.onWriteUserState(\n        currentAttemptState.attemptGuid,\n        partAttempt?.attemptGuid,\n        payload,\n      );\n    }\n  };\n\n  const handleGetData = async (payload: any) => {\n    const currentAttemptState = sharedAttemptStateMap.get(props.model.id);\n    // part attempt guid should be located in currentAttemptState.parts matched to id\n    const partAttempt = currentAttemptState.parts.find((p: any) => p.partId === payload.id);\n    if (!partAttempt) {\n      // throw err? if this happens we can't proceed...\n      console.error(`part attempt guid for ${payload.id} not found!`);\n      return;\n    }\n    if (props.onReadUserState) {\n      return await props.onReadUserState(\n        currentAttemptState.attemptGuid,\n        partAttempt?.attemptGuid,\n        payload,\n      );\n    }\n  };\n\n  const handlePartSave = async ({ id, responses }: { id: string | number; responses: any[] }) => {\n    /* console.log('onPartSave', { id, responses }); */\n    if (!responses || !responses.length) {\n      // TODO: throw? no reason to save something with no response\n      return;\n    }\n    const currentAttemptState = sharedAttemptStateMap.get(props.model.id);\n    // part attempt guid should be located in currentAttemptState.parts matched to id\n    const partAttempt = currentAttemptState.parts.find((p: any) => p.partId === id);\n    if (!partAttempt) {\n      // throw err? if this happens we can't proceed...\n      console.error(`part attempt guid for ${id} not found!`, { currentAttemptState });\n      return;\n    }\n    const response: ActivityTypes.StudentResponse = {\n      input: responses.map((pr) => ({ ...pr, path: `${id}.${pr.key}` })),\n    };\n    const result = await props.onSavePart(\n      currentAttemptState.attemptGuid,\n      partAttempt?.attemptGuid,\n      response,\n    );\n    // BS: this is the result from the layout pushed down, need to push down to part here?\n    return result;\n  };\n\n  const handlePartSubmit = async ({ id, responses }: { id: string | number; responses: any[] }) => {\n    /* console.log('onPartSubmit', { id, responses }); */\n    const currentAttemptState = sharedAttemptStateMap.get(props.model.id);\n    // part attempt guid should be located in currentAttemptState.parts matched to id\n    const partAttempt = currentAttemptState.parts.find((p: any) => p.partId === id);\n    if (!partAttempt) {\n      // throw err? if this happens we can't proceed...\n      console.error(`part attempt guid for ${id} not found!`);\n      return;\n    }\n    const response: ActivityTypes.StudentResponse = {\n      input: responses.map((pr) => ({ ...pr, path: `${id}.${pr.key}` })),\n    };\n    const result = await props.onSubmitPart(\n      currentAttemptState.attemptGuid,\n      partAttempt?.attemptGuid,\n      response,\n    );\n    // BS: this is the result from the layout pushed down, need to push down to part here?\n    return result;\n  };\n\n  return init ? (\n    <NotificationContext.Provider value={pusher}>\n      <PartsLayoutRenderer\n        parts={parts}\n        onPartInit={handlePartInit}\n        onPartReady={handlePartReady}\n        onPartSave={handlePartSave}\n        onPartSubmit={handlePartSubmit}\n        onPartResize={handlePartResize}\n        onPartSetData={handleSetData}\n        onPartGetData={handleGetData}\n      />\n    </NotificationContext.Provider>\n  ) : null;\n};\n\n// Defines the web component, a simple wrapper over our React component above\nexport class AdaptiveDelivery extends DeliveryElement<AdaptiveModelSchema> {\n  disconnectedCallback() {\n    ReactDOM.unmountComponentAtNode(this.mountPoint);\n    this.connected = false;\n  }\n\n  render(mountPoint: HTMLDivElement, props: DeliveryElementProps<AdaptiveModelSchema>) {\n    ReactDOM.render(<Adaptive {...props} />, mountPoint);\n  }\n}\n\n// Register the web component:\n// eslint-disable-next-line\nconst manifest = require('./manifest.json') as ActivityTypes.Manifest;\nwindow.customElements.define(manifest.delivery.element, AdaptiveDelivery);\n"]}