{"version":3,"file":"AdaptiveAuthoring.jsx","sourceRoot":"","sources":["../../../../../src/components/activities/adaptive/AdaptiveAuthoring.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  NotificationContext,\n  NotificationType,\n  subscribeToNotification,\n} from 'apps/delivery/components/NotificationContext';\nimport { AnyPartComponent } from 'components/parts/types/parts';\nimport EventEmitter from 'events';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport ReactDOM from 'react-dom';\nimport { clone } from 'utils/common';\nimport { AuthoringElement, AuthoringElementProps } from '../AuthoringElement';\nimport * as ActivityTypes from '../types';\nimport LayoutEditor from './components/authoring/LayoutEditor';\nimport { AdaptiveModelSchema } from './schema';\n\nconst Adaptive = (\n  props: AuthoringElementProps<AdaptiveModelSchema> & { hostRef?: HTMLElement },\n) => {\n  // we create this to be able to further send down notifcations that came from the parent notifier\n  const [pusher, setPusher] = useState(new EventEmitter().setMaxListeners(50));\n\n  useEffect(() => {\n    if (!props.notify) {\n      return;\n    }\n    const notificationsHandled = [\n      NotificationType.CHECK_STARTED,\n      NotificationType.CHECK_COMPLETE,\n      NotificationType.CONTEXT_CHANGED,\n      NotificationType.STATE_CHANGED,\n      NotificationType.CONFIGURE,\n      NotificationType.CONFIGURE_CANCEL,\n      NotificationType.CONFIGURE_SAVE,\n    ];\n    const notifications = notificationsHandled.map((notificationType: NotificationType) => {\n      const handler = (e: any) => {\n        // for now we will just forward the notification to the context\n        pusher.emit(notificationType.toString(), e);\n      };\n      const unsub = subscribeToNotification(\n        props.notify as EventEmitter,\n        notificationType,\n        handler,\n      );\n      return unsub;\n    });\n    return () => {\n      notifications.forEach((unsub) => {\n        unsub();\n      });\n    };\n  }, [props.notify]);\n\n  const [selectedPartId, setSelectedPartId] = useState('');\n  const [configurePortalId, setConfigurePortalId] = useState('');\n  const [parts, setParts] = useState<any[]>(props.model?.content?.partsLayout || []);\n\n  // this effect keeps the local parts state in sync with the props\n  useEffect(() => {\n    setParts(props.model?.content?.partsLayout || []);\n  }, [props.model?.content?.partsLayout]);\n\n  // this effect sets the selection from the outside based on authoring context\n  useEffect(() => {\n    if (props.authoringContext) {\n      /* console.log('[AdaptiveAuthoring] AuthoringContext: ', props.authoringContext); */\n      setSelectedPartId(props.authoringContext.selectedPartId);\n      setConfigurePortalId(props.authoringContext.configurePortalId || '');\n    }\n  }, [props.authoringContext]);\n\n  const handleLayoutChange = useCallback(\n    async (parts: AnyPartComponent[]) => {\n      /* console.log('Layout Change!', parts); */\n      const modelClone = clone(props.model);\n      modelClone.content.partsLayout = parts;\n      props.onEdit(modelClone);\n    },\n    [props.model],\n  );\n\n  const handlePartSelect = useCallback(\n    async (partId: string) => {\n      if (!props.editMode) {\n        return;\n      }\n      setSelectedPartId(partId);\n      if (props.onCustomEvent) {\n        const result = await props.onCustomEvent('selectPart', { id: partId });\n        /* console.log('got result from onSelect', result); */\n      }\n    },\n    [props.onCustomEvent, props.editMode, selectedPartId],\n  );\n\n  const handleCopyComponent = useCallback(\n    async (selectedPart: any) => {\n      /* console.log('AUTHOR PART COPY', { selectedPart }); */\n      if (props.onCustomEvent) {\n        const result = await props.onCustomEvent('copyPart', { copiedPart: selectedPart });\n      }\n      //dispatch(setCopiedPart({ copiedPart: selectedPart }));\n    },\n    [props.onCustomEvent],\n  );\n\n  const handleConfigurePart = useCallback(\n    async (part: any, context: any) => {\n      /* console.log('[AdaptiveAuthoring] PART CONFIGURE', { part, context }); */\n      if (props.onCustomEvent) {\n        const result = await props.onCustomEvent('configurePart', {\n          part,\n          context,\n        });\n      }\n    },\n    [props.onCustomEvent],\n  );\n\n  const handleCancelConfigurePart = useCallback(\n    async (partId: string) => {\n      /* console.log('AUTHOR PART CANCEL CONFIGURE', { partId }); */\n      if (props.onCustomEvent) {\n        const result = await props.onCustomEvent('cancelConfigurePart', {\n          partId,\n        });\n      }\n    },\n    [props.onCustomEvent],\n  );\n\n  return (\n    <NotificationContext.Provider value={pusher}>\n      <LayoutEditor\n        id={props.model.id || ''}\n        hostRef={props.hostRef}\n        width={props.model.content?.custom?.width || 1000}\n        height={props.model.content?.custom?.height || 500}\n        backgroundColor={props.model.content?.custom?.palette.backgroundColor || '#fff'}\n        selected={selectedPartId}\n        parts={parts}\n        onChange={handleLayoutChange}\n        onCopyPart={handleCopyComponent}\n        onConfigurePart={handleConfigurePart}\n        onCancelConfigurePart={handleCancelConfigurePart}\n        configurePortalId={configurePortalId}\n        onSelect={handlePartSelect}\n      />\n    </NotificationContext.Provider>\n  );\n};\n\nexport class AdaptiveAuthoring extends AuthoringElement<AdaptiveModelSchema> {\n  props() {\n    const superProps = super.props();\n    return {\n      ...superProps,\n      hostRef: this,\n    };\n  }\n\n  render(mountPoint: HTMLDivElement, props: AuthoringElementProps<AdaptiveModelSchema>) {\n    ReactDOM.render(<Adaptive {...props} />, mountPoint);\n  }\n}\n// eslint-disable-next-line\nconst manifest = require('./manifest.json') as ActivityTypes.Manifest;\nwindow.customElements.define(manifest.authoring.element, AdaptiveAuthoring);\n"]}