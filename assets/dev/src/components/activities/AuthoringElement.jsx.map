{"version":3,"file":"AuthoringElement.jsx","sourceRoot":"","sources":["../../../../src/components/activities/AuthoringElement.tsx"],"names":[],"mappings":"AACA,OAAO,OAAO,MAAM,OAAO,CAAC;AAC5B,OAAO,KAAK,EAAE,EAAE,UAAU,EAAE,MAAM,OAAO,CAAC;AAC1C,OAAO,EAAE,KAAK,EAAE,MAAM,SAAS,CAAC;AAEhC,OAAO,EAAE,YAAY,EAAE,MAAM,QAAQ,CAAC;AActC,+DAA+D;AAC/D,4EAA4E;AAC5E,mEAAmE;AACnE,sEAAsE;AACtE,oEAAoE;AACpE,yEAAyE;AACzE,6DAA6D;AAC7D,MAAM,OAAgB,gBAAgD,SAAQ,WAAW;IAMvF;QACE,KAAK,EAAE,CAAC;QAER,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAEhD,IAAI,CAAC,OAAO,GAAG,IAAI,YAAY,EAAE,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC;IACxD,CAAC;IAED,KAAK;QACH,MAAM,OAAO,GAAG,CAAC,GAAW,EAAE,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,YAAY,CAAC,GAAG,CAAQ,CAAC,CAAC;QAC3E,MAAM,KAAK,GAAG,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC;QACzD,MAAM,QAAQ,GAAY,IAAI,CAAC,YAAY,CAAC,UAAU,CAAC,KAAK,MAAM,CAAC;QACnE,MAAM,WAAW,GAAgB,IAAI,CAAC,YAAY,CAAC,aAAa,CAAW,CAAC;QAC5E,IAAI,gBAAgB,GAAQ,EAAE,CAAC;QAC/B,IAAI,IAAI,CAAC,YAAY,CAAC,kBAAkB,CAAC,EAAE;YACzC,gBAAgB,GAAG,OAAO,CAAC,kBAAkB,CAAC,CAAC;SAChD;QAED,MAAM,MAAM,GAAG,CAAC,KAAQ,EAAE,EAAE;YAC1B,IAAI,CAAC,aAAa,CAAC,IAAI,WAAW,CAAC,cAAc,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC,CAAC;QAC5F,CAAC,CAAC;QACF,MAAM,cAAc,GAAG,CAAC,QAAkB,EAAE,EAAE;YAC5C,IAAI,CAAC,aAAa,CAAC,IAAI,WAAW,CAAC,cAAc,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE,QAAQ,EAAE,EAAE,CAAC,CAAC,CAAC;QAC/F,CAAC,CAAC;QACF,MAAM,cAAc,GAAG,CAAC,OAAyB,EAAE,EAAE;YACnD,OAAO,IAAI,CAAC,QAAQ,CAAC,cAAc,EAAE,OAAO,CAAC,CAAC;QAChD,CAAC,CAAC;QACF,MAAM,aAAa,GAAG,CAAC,SAAiB,EAAE,OAAY,EAAE,EAAE;YACxD,OAAO,IAAI,CAAC,QAAQ,CAAC,aAAa,EAAE,EAAE,SAAS,EAAE,OAAO,EAAE,CAAC,CAAC;QAC9D,CAAC,CAAC;QAEF,OAAO;YACL,MAAM;YACN,cAAc;YACd,cAAc;YACd,aAAa;YACb,KAAK;YACL,QAAQ;YACR,WAAW;YACX,gBAAgB;YAChB,MAAM,EAAE,IAAI,CAAC,OAAO;SACrB,CAAC;IACJ,CAAC;IAED,mBAAmB,CAAC,KAAU;QAC5B,OAAO,KAAU,CAAC;IACpB,CAAC;IAED,OAAO,CAAC,YAA+C,EAAE,OAAa;QACpE,OAAO;YACL,OAAO,EAAE,IAAI;YACb,MAAM,EAAE;gBACN,OAAO;gBACP,YAAY;gBACZ,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE;aACpB;SACF,CAAC;IACJ,CAAC;IAED,QAAQ,CAAC,IAAY,EAAE,OAAa;QAClC,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YACrC,MAAM,YAAY,GAAG,CAAC,MAAW,EAAE,KAAU,EAAE,EAAE;gBAC/C,IAAI,KAAK,KAAK,SAAS,EAAE;oBACvB,MAAM,CAAC,KAAK,CAAC,CAAC;oBACd,OAAO;iBACR;gBACD,OAAO,CAAC,MAAM,CAAC,CAAC;YAClB,CAAC,CAAC;YACF,IAAI,CAAC,aAAa,CAAC,IAAI,WAAW,CAAC,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE,OAAO,CAAC,CAAC,CAAC,CAAC;QACjF,CAAC,CAAC,CAAC;IACL,CAAC;IAED,MAAM,CAAC,SAAiB,EAAE,OAAY;QACpC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC;IACxC,CAAC;IAID,iBAAiB;QACf,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAClC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;QAC3C,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;IACxB,CAAC;IAED,wBAAwB,CAAC,KAAU,EAAE,SAAc,EAAE,SAAc;QACjE,IAAI,IAAI,CAAC,SAAS,EAAE;YAClB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;SAC5C;IACH,CAAC;;AAED,sDAAsD;AAC/C,mCAAkB,GAAG,CAAC,UAAU,EAAE,OAAO,EAAE,kBAAkB,CAAC,CAAC;AAUxE,MAAM,uBAAuB,GAAG,KAAK,CAAC,aAAa,CACjD,SAAS,CACV,CAAC;AACF,MAAM,UAAU,0BAA0B;IACxC,OAAO,KAAK,CAAC,KAAK,CAChB,UAAU,CAAuC,uBAAuB,CAAC,CAC1E,CAAC,YAAY,CACZ,IAAI,KAAK,CAAC,4EAA4E,CAAC,CACxF,CAAC;AACJ,CAAC;AACD,MAAM,CAAC,MAAM,wBAAwB,GAAyD,CAAC,EAC7F,WAAW,EACX,QAAQ,EACR,QAAQ,EACR,KAAK,EACL,cAAc,EACd,cAAc,EACd,MAAM,GACP,EAAE,EAAE;IACH,MAAM,QAAQ,GAA2C,CAAC,MAAM,EAAE,EAAE;QAClE,MAAM,QAAQ,GAAG,OAAO,CAAC,KAAK,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,MAAM,CAAC,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC;QACpF,MAAM,CAAC,QAAQ,CAAC,CAAC;QACjB,OAAO,QAAQ,CAAC;IAClB,CAAC,CAAC;IACF,OAAO,CACL,CAAC,uBAAuB,CAAC,QAAQ,CAC/B,KAAK,CAAC,CAAC,EAAE,WAAW,EAAE,QAAQ,EAAE,QAAQ,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC,CAElE;MAAA,CAAC,QAAQ,CACX;IAAA,EAAE,uBAAuB,CAAC,QAAQ,CAAC,CACpC,CAAC;AACJ,CAAC,CAAC","sourcesContent":["import { ProjectSlug } from 'data/types';\nimport produce from 'immer';\nimport React, { useContext } from 'react';\nimport { Maybe } from 'tsmonad';\nimport { ActivityModelSchema, MediaItemRequest, PostUndoable, Undoable } from './types';\nimport { EventEmitter } from 'events';\n\nexport interface AuthoringElementProps<T extends ActivityModelSchema> {\n  model: T;\n  onEdit: (model: T) => void;\n  onPostUndoable: (undoable: Undoable) => void;\n  onRequestMedia: (request: MediaItemRequest) => Promise<string | boolean>;\n  onCustomEvent?: (eventName: string, payload: any) => Promise<any>;\n  editMode: boolean;\n  projectSlug: ProjectSlug;\n  authoringContext?: any;\n  notify?: EventEmitter;\n}\n\n// An abstract authoring web component, designed to delegate to\n// a React authoring component.  This authoring web component will re-render\n// the underlying React component when the 'model' attribute of the\n// the web component changes.  It also traps onEdit callbacks from the\n// React component and translated these calls into dispatches of the\n// 'modelUpdated' CustomEvent.  It is this CustomEvent that is handled by\n// Torus to process updates from the authoring web component.\nexport abstract class AuthoringElement<T extends ActivityModelSchema> extends HTMLElement {\n  mountPoint: HTMLDivElement;\n  connected: boolean;\n\n  protected _notify: EventEmitter;\n\n  constructor() {\n    super();\n\n    this.mountPoint = document.createElement('div');\n\n    this._notify = new EventEmitter().setMaxListeners(50);\n  }\n\n  props(): AuthoringElementProps<T> {\n    const getProp = (key: string) => JSON.parse(this.getAttribute(key) as any);\n    const model = this.migrateModelVersion(getProp('model'));\n    const editMode: boolean = this.getAttribute('editmode') === 'true';\n    const projectSlug: ProjectSlug = this.getAttribute('projectSlug') as string;\n    let authoringContext: any = {};\n    if (this.getAttribute('authoringcontext')) {\n      authoringContext = getProp('authoringcontext');\n    }\n\n    const onEdit = (model: T) => {\n      this.dispatchEvent(new CustomEvent('modelUpdated', { bubbles: true, detail: { model } }));\n    };\n    const onPostUndoable = (undoable: Undoable) => {\n      this.dispatchEvent(new CustomEvent('postUndoable', { bubbles: true, detail: { undoable } }));\n    };\n    const onRequestMedia = (request: MediaItemRequest) => {\n      return this.dispatch('requestMedia', request);\n    };\n    const onCustomEvent = (eventName: string, payload: any) => {\n      return this.dispatch('customEvent', { eventName, payload });\n    };\n\n    return {\n      onEdit,\n      onPostUndoable,\n      onRequestMedia,\n      onCustomEvent,\n      model,\n      editMode,\n      projectSlug,\n      authoringContext,\n      notify: this._notify,\n    };\n  }\n\n  migrateModelVersion(model: any): T {\n    return model as T;\n  }\n\n  details(continuation: (result: any, error: any) => void, payload?: any) {\n    return {\n      bubbles: true,\n      detail: {\n        payload,\n        continuation,\n        props: this.props(),\n      },\n    };\n  }\n\n  dispatch(name: string, payload?: any): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const continuation = (result: any, error: any) => {\n        if (error !== undefined) {\n          reject(error);\n          return;\n        }\n        resolve(result);\n      };\n      this.dispatchEvent(new CustomEvent(name, this.details(continuation, payload)));\n    });\n  }\n\n  notify(eventName: string, payload: any): void {\n    this._notify.emit(eventName, payload);\n  }\n\n  abstract render(mountPoint: HTMLDivElement, props: AuthoringElementProps<T>): void;\n\n  connectedCallback() {\n    this.appendChild(this.mountPoint);\n    this.render(this.mountPoint, this.props());\n    this.connected = true;\n  }\n\n  attributeChangedCallback(_name: any, _oldValue: any, _newValue: any) {\n    if (this.connected) {\n      this.render(this.mountPoint, this.props());\n    }\n  }\n\n  // Lower case here as opposed to camelCase is required\n  static observedAttributes = ['editmode', 'model', 'authoringcontext'];\n}\n\nexport interface AuthoringElementState<T> {\n  projectSlug: string;\n  editMode: boolean;\n  onRequestMedia: (request: MediaItemRequest) => Promise<string | boolean>;\n  dispatch: (action: (model: T, post: PostUndoable) => any) => T;\n  model: T;\n}\nconst AuthoringElementContext = React.createContext<AuthoringElementState<any> | undefined>(\n  undefined,\n);\nexport function useAuthoringElementContext<T>() {\n  return Maybe.maybe(\n    useContext<AuthoringElementState<T> | undefined>(AuthoringElementContext),\n  ).valueOrThrow(\n    new Error('useAuthoringElementContext must be used within an AuthoringElementProvider'),\n  );\n}\nexport const AuthoringElementProvider: React.FC<AuthoringElementProps<ActivityModelSchema>> = ({\n  projectSlug,\n  editMode,\n  children,\n  model,\n  onPostUndoable,\n  onRequestMedia,\n  onEdit,\n}) => {\n  const dispatch: AuthoringElementState<any>['dispatch'] = (action) => {\n    const newModel = produce(model, (draftState) => action(draftState, onPostUndoable));\n    onEdit(newModel);\n    return newModel;\n  };\n  return (\n    <AuthoringElementContext.Provider\n      value={{ projectSlug, editMode, dispatch, model, onRequestMedia }}\n    >\n      {children}\n    </AuthoringElementContext.Provider>\n  );\n};\n"]}