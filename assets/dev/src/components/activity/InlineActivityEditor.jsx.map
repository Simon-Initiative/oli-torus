{"version":3,"file":"InlineActivityEditor.jsx","sourceRoot":"","sources":["../../../../src/components/activity/InlineActivityEditor.tsx"],"names":[],"mappings":"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","sourcesContent":["import { ActivityModelSchema, Undoable } from 'components/activities/types';\nimport { PartObjectives } from 'components/activity/PartObjectives';\nimport { selectImage } from 'components/editing/commands/ImageCmd';\nimport { Tags } from 'components/resource/Tags';\nimport { ActivityEditContext, ObjectiveMap } from 'data/content/activity';\nimport { Objective } from 'data/content/objective';\nimport { Tag } from 'data/content/tags';\nimport { ResourceId } from 'data/types';\nimport React from 'react';\nimport { valueOr } from 'utils/common';\nimport { TitleBar } from '../content/TitleBar';\n\nexport interface ActivityEditorProps extends ActivityEditContext {\n  onEdit: (state: EditorUpdate) => void;\n  onPostUndoable: (undoable: Undoable) => void;\n  onRegisterNewObjective: (o: Objective) => void;\n  onRegisterNewTag: (o: Tag) => void;\n  editMode: boolean;\n  projectSlug: string;\n  allObjectives: Objective[];\n  allTags: Tag[];\n  banked: boolean;\n}\n\n// This is the state of our activity editing that is undoable\nexport type EditorUpdate = {\n  title: string;\n  content: ActivityModelSchema;\n  objectives: ObjectiveMap;\n  tags: ResourceId[];\n};\n\n// The activity editor\nexport class InlineActivityEditor extends React.Component<\n  ActivityEditorProps,\n  Record<string, never>\n> {\n  ref: any;\n\n  constructor(props: ActivityEditorProps) {\n    super(props);\n\n    this.update = this.update.bind(this);\n    this.ref = React.createRef();\n  }\n\n  componentDidMount() {\n    if (this.ref !== null) {\n      this.ref.current.addEventListener('modelUpdated', (e: CustomEvent) => {\n        e.preventDefault();\n        e.stopPropagation();\n\n        // Convert it back to using 'content', instead of 'model'\n        this.update({ content: Object.assign({}, e.detail.model) });\n      });\n      this.ref.current.addEventListener('postUndoable', (e: CustomEvent) => {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.props.onPostUndoable(e.detail.undoable);\n      });\n      this.ref.current.addEventListener('requestMedia', (e: CustomEvent) => {\n        e.preventDefault();\n        e.stopPropagation();\n\n        selectImage(this.props.projectSlug).then((result) => {\n          if (result) {\n            e.detail.continuation(result);\n          } else {\n            e.detail.continuation(undefined, 'error');\n          }\n        });\n      });\n    }\n  }\n\n  update(update: Partial<EditorUpdate>) {\n    const syncedUpdate = this.syncObjectivesWithParts(update);\n    const combined = Object.assign(\n      {},\n      {\n        title: this.props.title,\n        content: this.props.model,\n        objectives: this.props.objectives,\n        tags: this.props.tags,\n      },\n      syncedUpdate,\n    );\n\n    this.props.onEdit(combined);\n  }\n\n  // Parts can be added or removed in multi-part activities\n  syncObjectivesWithParts(update: Partial<EditorUpdate>) {\n    if (update.content !== undefined) {\n      const objectives = this.props.objectives;\n      const parts = valueOr(update.content.authoring.parts, []);\n      const partIds = parts\n        .map((p: any) => valueOr(String(p.id), ''))\n        .reduce((m: any, id: string) => {\n          m[id] = true;\n          return m;\n        }, {});\n\n      this.removeMissingPartIds(objectives, partIds);\n      this.addMissingPartIds(objectives, partIds);\n\n      return Object.assign({}, update, { objectives });\n    }\n    return update;\n  }\n\n  removeMissingPartIds(objectives: ObjectiveMap, partIds: Record<string, boolean>): void {\n    Object.keys(objectives).forEach((pId) => {\n      if (partIds[pId] === undefined) {\n        delete objectives[pId];\n      }\n    });\n  }\n\n  // Newly added parts have no attached objectives\n  addMissingPartIds(objectives: ObjectiveMap, partIds: Record<string, boolean>): void {\n    Object.keys(partIds).forEach((pId) => {\n      if (objectives[pId.toString()] === undefined) {\n        objectives[pId] = [];\n      }\n    });\n  }\n\n  render() {\n    const { authoringElement } = this.props;\n\n    const onTitleEdit = (title: string) => {\n      this.update({ title });\n    };\n\n    const webComponentProps = {\n      key: this.props.activityId,\n      model: JSON.stringify(this.props.model),\n      editmode: new Boolean(this.props.editMode).toString(),\n      projectslug: this.props.projectSlug,\n    };\n    const parts = valueOr(this.props.model.authoring.parts, []);\n    const partIds = parts.map((p: any) => p.id);\n\n    const maybeTags = this.props.banked ? (\n      <div className=\"card\">\n        <div className=\"card-body\">\n          <div className=\"card-title\">Tags</div>\n          <Tags\n            selected={this.props.tags}\n            editMode={this.props.editMode}\n            projectSlug={webComponentProps.projectslug}\n            tags={this.props.allTags}\n            onRegisterNewTag={this.props.onRegisterNewTag}\n            onEdit={(tags) => this.update({ tags })}\n          />\n        </div>\n      </div>\n    ) : null;\n\n    return (\n      <div className=\"col-12\">\n        <div className=\"activity-editor\">\n          <TitleBar\n            title={this.props.title}\n            onTitleEdit={onTitleEdit}\n            editMode={this.props.editMode}\n          >\n            <div />\n          </TitleBar>\n          <PartObjectives\n            partIds={partIds}\n            editMode={this.props.editMode}\n            projectSlug={webComponentProps.projectslug}\n            objectives={this.props.objectives}\n            allObjectives={this.props.allObjectives}\n            onRegisterNewObjective={this.props.onRegisterNewObjective}\n            onEdit={(objectives) => this.update({ objectives })}\n          />\n          {maybeTags}\n          <div ref={this.ref}>\n            {React.createElement(authoringElement, webComponentProps as any)}\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n"]}