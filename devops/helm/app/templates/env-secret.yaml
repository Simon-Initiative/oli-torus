{{- $ := . -}}
{{- $defaults := dict
  "PHX_SERVER" "true"
  "FORCE_SSL" "false"
  "SCHEME" "https"
  "PORT" "443"
  "SECRET_KEY_BASE" "ba1sX03RVQyAk3MPRfUeG7LQxUPRe3IB3iN3VnTHYFxUgsz2vAUDof/kGCiyaigs"
  "LIVE_VIEW_SALT" "vf6j/P8XSYOVNs3aKUQ5SQCfunWheQPQ+EDzfBJM0FBTLcyTHZlmQGXbBBbSJwkV"
  "ADMIN_EMAIL" "admin@example.edu"
  "ADMIN_PASSWORD" "changeme"
  "EMAIL_FROM_NAME" "OLI Torus"
  "EMAIL_FROM_ADDRESS" "no-reply@example.edu"
  "EMAIL_REPLY_TO" "admin@example.edu"
  "BRANDING_LOGO" "/branding/dev/oli_torus_logo.png"
  "BRANDING_LOGO_DARK" "/branding/dev/oli_torus_logo_dark.png"
  "BRANDING_FAVICONS_DIR" "/branding/dev/favicons"
  "VENDOR_PROPERTY_WORKSPACE_LOGO" "/branding/dev/oli_torus_icon.png"
  "S3_MEDIA_BUCKET_NAME" "torus-media"
  "S3_XAPI_BUCKET_NAME" "torus-xapi"
  "AWS_S3_ACCESS_KEY_ID" "minio-user"
  "AWS_S3_SECRET_ACCESS_KEY" "minio-password"
  "AWS_S3_SCHEME" "http"
  "AWS_S3_PORT" "9000"
  "CLOAK_VAULT_KEY" "HXCdm5z61eNgUpnXObJRv94k3JnKSrnfwppyb60nz6w="
  "LIVEBOOK_ENABLED" "false"
}}
{{- $overrides := .Values.appEnv.overrides | default dict -}}
{{- $data := merge (dict) $defaults $overrides -}}

{{- $host := include "oli-torus-preview.hostname" . -}}
{{- $postgresService := include "oli-torus-preview.postgresName" . -}}
{{- $minioService := include "oli-torus-preview.minioName" . -}}

{{- if not (hasKey $data "HOST") -}}
  {{- $_ := set $data "HOST" $host -}}
{{- end -}}
{{- if not (hasKey $data "DATABASE_URL") -}}
  {{- $_ := set $data "DATABASE_URL" (printf "postgres://%s:%s@%s:5432/%s" .Values.postgres.auth.username .Values.postgres.auth.password $postgresService .Values.postgres.auth.database) -}}
{{- end -}}
{{- if not (hasKey $data "MEDIA_URL") -}}
  {{- $minioPath := .Values.ingress.minioPathPrefix | default "/minio" -}}
  {{- $trimmedPath := trimPrefix "/" $minioPath -}}
  {{- $_ := set $data "MEDIA_URL" (printf "https://%s/%s/%s" $host $trimmedPath (get $data "S3_MEDIA_BUCKET_NAME")) -}}
{{- end -}}
{{- if not (hasKey $data "AWS_S3_HOST") -}}
  {{- $_ := set $data "AWS_S3_HOST" $minioService -}}
{{- end -}}
{{- if not (hasKey $data "AWS_S3_ACCESS_KEY_ID") -}}
  {{- $_ := set $data "AWS_S3_ACCESS_KEY_ID" .Values.minio.rootUser -}}
{{- end -}}
{{- if not (hasKey $data "AWS_S3_SECRET_ACCESS_KEY") -}}
  {{- $_ := set $data "AWS_S3_SECRET_ACCESS_KEY" .Values.minio.rootPassword -}}
{{- end -}}
{{- if not (hasKey $data "AWS_S3_PORT") -}}
  {{- $_ := set $data "AWS_S3_PORT" (printf "%v" .Values.minio.service.port) -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "oli-torus-preview.fullname" . }}-env
  labels:
    {{- include "oli-torus-preview.labels" . | nindent 4 }}
type: Opaque
stringData:
{{- range $key, $value := $data }}
  {{ $key }}: {{ tpl (printf "%v" $value) $ | quote }}
{{- end }}
